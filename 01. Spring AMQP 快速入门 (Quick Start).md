### ğŸ° RabbitMQ å¤ä¹ ç¬”è®°ç›®å½• (Spring AMQPç‰ˆ)

> è¯´æ˜ï¼šåœ¨ä¸æ”¹å˜åŸæœ‰ç¬”è®°å†…å®¹çš„å‰æä¸‹ï¼Œåªå¯¹ç»“æ„åšäº†è½»é‡æ•´ç†ï¼Œæ–¹ä¾¿â€œåŸºç¡€ç¯‡ / é«˜çº§ç¯‡â€ç³»ç»Ÿå¤ä¹ ã€‚

**æ•´ä½“ç»“æ„ï¼š**

- **åŸºç¡€ç¯‡ï¼šæ¶ˆæ¯æ¨¡å‹ä¸åŸºç¡€ç”¨æ³•**
  - 01. Spring AMQP å¿«é€Ÿå…¥é—¨ (Quick Start)
  - 02. Work æ¨¡å‹ (Work Queues)
  - 03. å‘å¸ƒè®¢é˜…æ¨¡å‹ - Fanout äº¤æ¢æœº
  - 04. è·¯ç”±æ¨¡å‹ - Direct äº¤æ¢æœº
  - 05. ä¸»é¢˜æ¨¡å‹ - Topic äº¤æ¢æœº
  - 06. å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼
  - 07. æ¶ˆæ¯è½¬æ¢å™¨ (Message Converter)
- **é«˜çº§ç¯‡ï¼šå¯é æ€§ã€å»¶è¿Ÿæ¶ˆæ¯ä¸ç»¼åˆæ¡ˆä¾‹**
  - 01. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…é‡è¿ (Producer Retry)
  - 02. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…ç¡®è®¤åŸç† (Confirm / Return)
  - 03. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…ç¡®è®¤ä»£ç å®ç°
  - 04. MQ çš„å¯é æ€§ - æ•°æ®æŒä¹…åŒ– (Exchange / Queue / Message)
  - 05. MQ çš„å¯é æ€§ - Lazy Queue (æƒ°æ€§é˜Ÿåˆ—)
  - 06. æ¶ˆè´¹è€…å¯é æ€§ - æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ (Ack æ¨¡å¼)
  - 07. æ¶ˆè´¹è€…å¯é æ€§ - å¤±è´¥é‡è¯•æœºåˆ¶ (Spring Retry + Recoverer)
  - 08. æ¶ˆè´¹è€…å¯é æ€§ - ä¸šåŠ¡å¹‚ç­‰æ€§ (Idempotency)
  - 09. å»¶è¿Ÿæ¶ˆæ¯ - åŸºç¡€æ¦‚å¿µ
  - 10. æ–¹æ¡ˆä¸€ï¼šæ­»ä¿¡äº¤æ¢æœº (DLX) + TTL
  - 11. æ–¹æ¡ˆäºŒï¼šå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶ (Delayed Message Plugin)
  - 12. ç»¼åˆæ¡ˆä¾‹ï¼šå–æ¶ˆè¶…æ—¶è®¢å•

---

# åŸºç¡€ç¯‡ï¼šæ¶ˆæ¯æ¨¡å‹ä¸åŸºç¡€ç”¨æ³•

## 01. Spring AMQP å¿«é€Ÿå…¥é—¨ (Quick Start)

æ ¸å¿ƒç»„ä»¶å›é¡¾ï¼š

- **RabbitTemplate**ï¼šSpring æä¾›çš„æ¶ˆæ¯å‘é€æ¨¡æ¿å·¥å…·ç±»ï¼ˆç±»ä¼¼äº JdbcTemplateï¼‰ã€‚

- **@RabbitListener**ï¼šç”¨äºå£°æ˜æ¶ˆè´¹è€…å¹¶ç›‘å¬é˜Ÿåˆ—çš„æ³¨è§£ã€‚

### 1. å¼•å…¥ä¾èµ–

åœ¨ä½¿ç”¨ Spring Boot ä¹‹å‰ï¼Œç¡®ä¿å¼•å…¥äº† AMQP çš„ starterã€‚

```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

### 2. åŸºç¡€é…ç½®

åœ¨Â application.ymlÂ ä¸­é…ç½®è¿æ¥ä¿¡æ¯ã€‚

```yaml
spring:
  rabbitmq:
    host: 192.168.150.101 # MQæœåŠ¡å™¨IP
    port: 5672            # é€šä¿¡ç«¯å£ (æ³¨æ„ä¸æ˜¯ç®¡æ§å°çš„15672)
    username: admin
    password: password
    virtual-host: /       # è™šæ‹Ÿä¸»æœº
```

### 3. ç¼–å†™ç”Ÿäº§è€… (Producer)

åˆ©ç”¨Â RabbitTemplateÂ å‘é€æ¶ˆæ¯ã€‚

> **å¤ä¹ é‡ç‚¹**ï¼šconvertAndSendÂ æ–¹æ³•ä¼šè‡ªåŠ¨å°† Java å¯¹è±¡åºåˆ—åŒ–ï¼ˆé»˜è®¤ JDK åºåˆ—åŒ–ï¼‰åå‘é€ã€‚

**æµ‹è¯•ç±»ç¤ºä¾‹ï¼š**

```java
@SpringBootTest
public class SpringAmqpTest {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    public void testSimpleQueue() {
        // é˜Ÿåˆ—åç§°
        String queueName = "simple.queue";
        // æ¶ˆæ¯å†…å®¹
        String message = "Hello, Spring AMQP!";

        // å‘é€æ¶ˆæ¯
        // å‚æ•°1: äº¤æ¢æœºåç§° (ç®€å•æ¨¡å¼ä¸‹è®¾ä¸º null æˆ– ""ï¼Œå³ä½¿ç”¨é»˜è®¤äº¤æ¢æœº)
        // å‚æ•°2: è·¯ç”±é”® (ç®€å•æ¨¡å¼ä¸‹å³ä¸ºé˜Ÿåˆ—å)
        // å‚æ•°3: æ¶ˆæ¯å†…å®¹
        rabbitTemplate.convertAndSend(queueName, message);

        System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸï¼");
    }
}
```

### 4. ç¼–å†™æ¶ˆè´¹è€… (Consumer)

åˆ©ç”¨Â @RabbitListenerÂ ç›‘å¬é˜Ÿåˆ—ã€‚

> **å¤ä¹ é‡ç‚¹**ï¼šæ–¹æ³•å‚æ•°ç±»å‹è¦ä¸å‘é€çš„æ¶ˆæ¯ç±»å‹ä¿æŒä¸€è‡´ï¼ˆæˆ–èƒ½è‡ªåŠ¨è½¬æ¢ï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚

**ç›‘å¬ç±»ç¤ºä¾‹ï¼š**

```java
@Component
public class SpringRabbitListener {

    /**     * ç›‘å¬ simple.queue é˜Ÿåˆ—     * æ³¨æ„ï¼šè¯¥é˜Ÿåˆ—å¿…é¡»åœ¨ RabbitMQ ä¸­å·²å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™ã€‚     * (é˜Ÿåˆ—å£°æ˜æ–¹å¼å°†åœ¨åç»­ç« èŠ‚è¯¦ç»†æ•´ç†)     */
    @RabbitListener(queues = "simple.queue")
    public void listenSimpleQueueMessage(String msg) {
        System.out.println("æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€" + msg + "ã€‘");
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
    }
}
```

### 5. å¿«é€Ÿå¤ä¹ å°è´´å£«

1. **é˜Ÿåˆ—å¿…é¡»å­˜åœ¨**ï¼šSpring AMQP é»˜è®¤ä¸ä¼šè‡ªåŠ¨åˆ›å»ºÂ @RabbitListenerÂ ä¸­æŒ‡å®šçš„é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œå¯åŠ¨ä¼šæŠ¥é”™ï¼ˆé™¤éä½¿ç”¨äº†åç»­ç« èŠ‚æåˆ°çš„å£°æ˜å¼æ³¨è§£ï¼‰ã€‚

2. **é»˜è®¤äº¤æ¢æœº**ï¼šconvertAndSendÂ å¦‚æœä¸æŒ‡å®šäº¤æ¢æœºï¼Œç›´æ¥å†™é˜Ÿåˆ—åä½œä¸º RoutingKeyï¼Œæ˜¯å› ä¸º RabbitMQ æœ‰ä¸€ä¸ªé»˜è®¤çš„ Direct Exchangeï¼ˆåå­—ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå®ƒä¼šè‡ªåŠ¨å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸ RoutingKey åŒåçš„é˜Ÿåˆ—ã€‚

## 02. Work æ¨¡å‹ (Work Queues)

**åœºæ™¯æè¿°**ï¼šä¸€ä¸ªç”Ÿäº§è€…å¯¹åº”ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä½†æœ‰**å¤šä¸ªæ¶ˆè´¹è€…**åŒæ—¶ç›‘å¬è¯¥é˜Ÿåˆ—ã€‚  
**åº”ç”¨åœºæ™¯**ï¼šä»»åŠ¡å¤„ç†é‡å¤§ï¼Œå•ä¸ªæ¶ˆè´¹è€…å¤„ç†ä¸è¿‡æ¥ï¼Œé€šè¿‡å¢åŠ æ¶ˆè´¹è€…å®ä¾‹æ¥æå‡å¤„ç†é€Ÿåº¦ï¼ˆå¦‚ç§’æ€åçš„è®¢å•å…¥åº“ã€çŸ­ä¿¡å‘é€ï¼‰ã€‚

### 1. é»˜è®¤æœºåˆ¶ï¼šè½®è¯¢åˆ†å‘ (Round-Robin)

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQ ä¼šå°†æ¶ˆæ¯**æŒ‰é¡ºåºã€å¹³å‡**åœ°åˆ†é…ç»™æ¯ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚ä¸ç®¡æ¶ˆè´¹è€…å¤„ç†å¾—å¿«è¿˜æ˜¯æ…¢ï¼Œæ‹¿åˆ°æ¶ˆæ¯çš„æ•°é‡æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚

#### 1.1 ç”Ÿäº§è€…ä»£ç  (æ¨¡æ‹Ÿå‘é€50æ¡æ¶ˆæ¯)

```java
@Test
public void testWorkQueue() throws InterruptedException {
    String queueName = "work.queue";
    for (int i = 1; i <= 50; i++) {
        String message = "task_" + i;
        rabbitTemplate.convertAndSend(queueName, message);
        Thread.sleep(20); // æ¨¡æ‹Ÿå‘é€é—´éš”
    }
}
```

#### 1.2 æ¶ˆè´¹è€…ä»£ç  (æ¨¡æ‹Ÿä¸¤ä¸ªæ¶ˆè´¹è€…)

æ³¨æ„ï¼šè¿™é‡Œæœªé…ç½® prefetchï¼Œé»˜è®¤æ˜¯è½®è¯¢ã€‚

```java
@Component
public class WorkConsumer {

    // æ¶ˆè´¹è€… 1
    @RabbitListener(queues = "work.queue")
    public void listenWorkQueue1(String msg) throws InterruptedException {
        System.out.println("æ¶ˆè´¹è€…1 æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
        Thread.sleep(20); // æ¨¡æ‹Ÿå¤„ç†é€Ÿåº¦å¿«ï¼Œæ¯ç§’å¤„ç†50ä¸ª
    }

    // æ¶ˆè´¹è€… 2
    @RabbitListener(queues = "work.queue")
    public void listenWorkQueue2(String msg) throws InterruptedException {
        System.err.println("æ¶ˆè´¹è€…2 æ¥æ”¶åˆ°æ¶ˆæ¯........ï¼š" + msg);
        Thread.sleep(200); // æ¨¡æ‹Ÿå¤„ç†é€Ÿåº¦æ…¢ï¼Œæ¯ç§’å¤„ç†5ä¸ª
    }
}
```

**ç»“æœ**ï¼šå³ä½¿æ¶ˆè´¹è€…1é€Ÿåº¦å¾ˆå¿«ï¼Œæ¶ˆè´¹è€…2å¾ˆæ…¢ï¼Œæœ€ç»ˆä¸¤äººå¤„ç†çš„æ¶ˆæ¯æ•°é‡éƒ½æ˜¯Â **25æ¡**ã€‚æ¶ˆè´¹è€…2ä¼šå †ç§¯å¾ˆå¤šä»»åŠ¡ï¼Œè€Œæ¶ˆè´¹è€…1æ—©æ—©å¹²å®Œæ´»é—²ç€ã€‚

---

### 2. ä¼˜åŒ–æœºåˆ¶ï¼šèƒ½è€…å¤šåŠ³ (Fair Dispatch) - é‡ç‚¹

ä¸ºäº†è§£å†³è½®è¯¢å¯¼è‡´çš„èµ„æºæµªè´¹ï¼ˆå¿«çš„äººæ²¡äº‹å¹²ï¼Œæ…¢çš„äººå¹²ä¸å®Œï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®ï¼Œè®© RabbitMQÂ **æ¯æ¬¡åªç»™æ¶ˆè´¹è€…å‘ 1 æ¡æ¶ˆæ¯**ï¼Œç­‰æ¶ˆè´¹è€…å¤„ç†å®Œå¹¶ ACK åï¼Œå†å‘ä¸‹ä¸€æ¡ã€‚

**æ ¸å¿ƒåŸç†**ï¼šè®¾ç½®Â prefetchÂ å€¼ã€‚

#### 2.1 ä¿®æ”¹ application.yml é…ç½®

è¿™æ˜¯ Spring Boot ä¸­å¼€å¯èƒ½è€…å¤šåŠ³çš„å…³é”®é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        prefetch: 1 # æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæ‰èƒ½è·å–ä¸‹ä¸€æ¡
```

#### 2.2 å†æ¬¡è¿è¡Œæµ‹è¯•

ä¿æŒä¸Šé¢çš„ä»£ç ä¸å˜ï¼Œå†æ¬¡è¿è¡Œç”Ÿäº§è€…ï¼š

- **æ¶ˆè´¹è€… 1**Â (å¿«)ï¼šå¯èƒ½ä¼šå¤„ç† 40+ æ¡æ¶ˆæ¯ã€‚

- **æ¶ˆè´¹è€… 2**Â (æ…¢)ï¼šå¯èƒ½åªå¤„ç†å‡ æ¡æ¶ˆæ¯ã€‚

**ç»“è®º**ï¼šå¤„ç†é€Ÿåº¦è¶Šå¿«ï¼ŒæŠ¢åˆ°çš„æ¶ˆæ¯è¶Šå¤šï¼Œå®ç°äº†è´Ÿè½½å‡è¡¡ã€‚

---

### 3. å¸¸è§é—®é¢˜ç¬”è®°

1. **prefetch é»˜è®¤å€¼**ï¼šSpring AMQP é»˜è®¤çš„ prefetch count æ˜¯ 250ã€‚è¿™åœ¨æ¶ˆæ¯å¤„ç†æ—¶é—´å·®å¼‚ä¸å¤§çš„æƒ…å†µä¸‹èƒ½æé«˜ååé‡ï¼Œä½†åœ¨å¤„ç†æ—¶é—´å·®å¼‚å·¨å¤§æ—¶ä¼šå¯¼è‡´ä¸å‡è¡¡ã€‚

2. **åŸç†**ï¼šè¿™æ˜¯åŸºäº RabbitMQ çš„ QoS (Quality of Service) æœºåˆ¶å®ç°çš„ã€‚Spring Boot è‡ªåŠ¨å¸®æˆ‘ä»¬è°ƒç”¨äº†Â channel.basicQos(1)ã€‚

---

## 03. å‘å¸ƒè®¢é˜…æ¨¡å‹ - Fanout äº¤æ¢æœº

**ç®€ä»‹**ï¼šFanout Exchange è¢«ç§°ä¸ºå¹¿æ’­äº¤æ¢æœºã€‚  
**ç‰¹ç‚¹**ï¼šå®ƒä¼šå°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯**å¹¿æ’­**åˆ°æ¯ä¸€ä¸ªä¸å®ƒç»‘å®šçš„é˜Ÿåˆ—ä¸­ã€‚**å®ƒå¿½ç•¥ RoutingKey**ï¼ˆè·¯ç”±é”®ï¼‰ã€‚

### 1. åœºæ™¯æ¨¡æ‹Ÿ

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª Fanout äº¤æ¢æœºï¼ˆitcast.fanoutï¼‰å’Œä¸¤ä¸ªé˜Ÿåˆ—ï¼ˆfanout.queue1,Â fanout.queue2ï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåœ¨ä¸€èµ·ã€‚

### 2. å£°æ˜é…ç½® (é…ç½®ç±»)

åœ¨ Spring Boot ä¸­ï¼Œé€šå¸¸ä½¿ç”¨Â @ConfigurationÂ +Â @BeanÂ æ¥å®šä¹‰è¿™ç§ç»‘å®šå…³ç³»ã€‚

> **æç¤º**ï¼šè¿™æ˜¯ç¬¬ä¸€ç§å£°æ˜æ–¹å¼ï¼ˆåŸºäºé…ç½®ç±»ï¼‰ï¼Œåé¢ä¼šè®²åŸºäºæ³¨è§£çš„ç®€ä¾¿æ–¹å¼ã€‚

```java
@Configuration
public class FanoutConfig {

    // 1. å£°æ˜ Fanout äº¤æ¢æœº
    @Bean
    public FanoutExchange fanoutExchange() {
        return new FanoutExchange("itcast.fanout");
    }

    // 2. å£°æ˜é˜Ÿåˆ— 1
    @Bean
    public Queue fanoutQueue1() {
        return new Queue("fanout.queue1");
    }

    // 3. å£°æ˜é˜Ÿåˆ— 2
    @Bean
    public Queue fanoutQueue2() {
        return new Queue("fanout.queue2");
    }

    // 4. ç»‘å®šé˜Ÿåˆ— 1 åˆ°äº¤æ¢æœº
    @Bean
    public Binding bindingQueue1(Queue fanoutQueue1, FanoutExchange fanoutExchange) {
        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);
    }

    // 5. ç»‘å®šé˜Ÿåˆ— 2 åˆ°äº¤æ¢æœº
    @Bean
    public Binding bindingQueue2(Queue fanoutQueue2, FanoutExchange fanoutExchange) {
        return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);
    }
}
```

### 3. ç”Ÿäº§è€…ä»£ç 

å‘é€æ¶ˆæ¯æ—¶ï¼Œ**å¿…é¡»æŒ‡å®šäº¤æ¢æœºåç§°**ã€‚å¯¹äº Fanout æ¨¡å¼ï¼ŒRoutingKey ä¸ç”Ÿæ•ˆï¼Œé€šå¸¸ä¼ ç©ºå­—ç¬¦ä¸²Â ""ã€‚

```java
@Test
public void testFanoutExchange() {
    // äº¤æ¢æœºåç§°
    String exchangeName = "itcast.fanout";
    // æ¶ˆæ¯
    String message = "hello everyone!";

    // å‘é€æ¶ˆæ¯
    // å‚æ•°1: äº¤æ¢æœº
    // å‚æ•°2: RoutingKey (Fanoutæ¨¡å¼ä¸‹å¡« "" å³å¯ï¼Œå¡«äº†ä¹Ÿè¢«å¿½ç•¥)
    // å‚æ•°3: æ¶ˆæ¯
    rabbitTemplate.convertAndSend(exchangeName, "", message);

    System.out.println("å¹¿æ’­æ¶ˆæ¯å‘é€æˆåŠŸï¼");
}
```

### 4. æ¶ˆè´¹è€…ä»£ç 

æ¶ˆè´¹è€…åªéœ€è¦ç›‘å¬å„è‡ªçš„é˜Ÿåˆ—å³å¯ï¼Œä¸éœ€è¦å…³å¿ƒäº¤æ¢æœºã€‚

```java
@Component
public class FanoutConsumer {

    @RabbitListener(queues = "fanout.queue1")
    public void listenFanoutQueue1(String msg) {
        System.out.println("æ¶ˆè´¹è€…1 (queue1) æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼š" + msg);
    }

    @RabbitListener(queues = "fanout.queue2")
    public void listenFanoutQueue2(String msg) {
        System.out.println("æ¶ˆè´¹è€…2 (queue2) æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼š" + msg);
    }
}
```

### 5. ç»“æœä¸æ€»ç»“

- **ç»“æœ**ï¼šè¿è¡Œæµ‹è¯•æ–¹æ³•ï¼Œæ¶ˆè´¹è€… 1 å’Œæ¶ˆè´¹è€… 2 éƒ½ä¼šæ”¶åˆ°å®Œå…¨ç›¸åŒçš„æ¶ˆæ¯ã€‚

- **é€‚ç”¨åœºæ™¯**ï¼šç³»ç»Ÿå…¬å‘Šã€æ¸¸æˆå…¨æœé€šçŸ¥ã€ç§¯åˆ†å˜åŠ¨é€šçŸ¥ï¼ˆåŒæ—¶è§¦å‘çŸ­ä¿¡ã€é‚®ä»¶ã€æ•°æ®åº“æ›´æ–°ç­‰å¤šä¸ªç‹¬ç«‹æœåŠ¡ï¼‰ã€‚

## 04. è·¯ç”±æ¨¡å‹ - Direct äº¤æ¢æœº

**ç®€ä»‹**ï¼šDirect Exchange æ ¹æ®Â **RoutingKey**Â å°†æ¶ˆæ¯è·¯ç”±åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ã€‚  
**è§„åˆ™**ï¼š**ç²¾ç¡®åŒ¹é…**ã€‚åªæœ‰å½“æ¶ˆæ¯çš„ RoutingKey ä¸é˜Ÿåˆ—ç»‘å®šæ—¶æŒ‡å®šçš„ BindingKey å®Œå…¨ä¸€è‡´æ—¶ï¼Œæ¶ˆæ¯æ‰ä¼šè¢«æŠ•é€’ã€‚

### 1. åœºæ™¯æ¨¡æ‹Ÿ

æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ª**æ—¥å¿—ç³»ç»Ÿ**ï¼š

- **Direct äº¤æ¢æœº**ï¼šitcast.direct

- **é˜Ÿåˆ— 1 (console.queue)**ï¼šç»‘å®š key ä¸ºÂ infoÂ å’ŒÂ errorã€‚ï¼ˆè´Ÿè´£æ‰“å°æ‰€æœ‰æ—¥å¿—ï¼‰

- **é˜Ÿåˆ— 2 (file.queue)**ï¼šåªç»‘å®š key ä¸ºÂ errorã€‚ï¼ˆè´Ÿè´£å°†é”™è¯¯æ—¥å¿—å†™å…¥æ–‡ä»¶ï¼‰

**é¢„æœŸç»“æœ**ï¼š

- å‘Â infoÂ -> åªæœ‰é˜Ÿåˆ— 1 æ”¶åˆ°ã€‚

- å‘Â errorÂ -> é˜Ÿåˆ— 1 å’Œ é˜Ÿåˆ— 2 éƒ½ä¼šæ”¶åˆ°ã€‚

### 2. å£°æ˜é…ç½® (é…ç½®ç±»)

ç»§ç»­ä½¿ç”¨Â @ConfigurationÂ é…ç½®ç»‘å®šå…³ç³»ã€‚æ³¨æ„è¿™é‡Œä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥ç»‘å®šå¤šä¸ª Keyã€‚

```java
@Configuration
public class DirectConfig {

    // 1. å£°æ˜ Direct äº¤æ¢æœº
    @Bean
    public DirectExchange directExchange() {
        return new DirectExchange("itcast.direct");
    }

    // 2. å£°æ˜é˜Ÿåˆ—
    @Bean
    public Queue consoleQueue() { return new Queue("console.queue"); }

    @Bean
    public Queue fileQueue() { return new Queue("file.queue"); }

    // 3. ç»‘å®šå…³ç³»
    // é˜Ÿåˆ—1 ç»‘å®š info
    @Bean
    public Binding bindingConsoleInfo(Queue consoleQueue, DirectExchange directExchange) {
        return BindingBuilder.bind(consoleQueue).to(directExchange).with("info");
    }
    // é˜Ÿåˆ—1 ç»‘å®š error (ä¸€ä¸ªé˜Ÿåˆ—å¯ä»¥ç»‘å®šå¤šä¸ªKey)
    @Bean
    public Binding bindingConsoleError(Queue consoleQueue, DirectExchange directExchange) {
        return BindingBuilder.bind(consoleQueue).to(directExchange).with("error");
    }

    // é˜Ÿåˆ—2 åªç»‘å®š error
    @Bean
    public Binding bindingFileError(Queue fileQueue, DirectExchange directExchange) {
        return BindingBuilder.bind(fileQueue).to(directExchange).with("error");
    }
}
```

### 3. ç”Ÿäº§è€…ä»£ç 

å‘é€æ¶ˆæ¯æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°Â **RoutingKey**Â è‡³å…³é‡è¦ã€‚

```java
@Test
public void testDirectExchange() {
    String exchangeName = "itcast.direct";

    // 1. å‘é€ info æ—¥å¿— -> åªæœ‰ consoleQueue æ”¶åˆ°
    String message1 = "è¿™æ˜¯ä¸€æ¡æ™®é€š info æ—¥å¿—";
    rabbitTemplate.convertAndSend(exchangeName, "info", message1);

    // 2. å‘é€ error æ—¥å¿— -> consoleQueue å’Œ fileQueue éƒ½ä¼šæ”¶åˆ°
    String message2 = "è¿™æ˜¯ä¸€æ¡ä¸¥é‡ error æŠ¥é”™";
    rabbitTemplate.convertAndSend(exchangeName, "error", message2);

    System.out.println("æ—¥å¿—æ¶ˆæ¯å‘é€å®Œæ¯•");
}
```

### 4. æ¶ˆè´¹è€…ä»£ç 

```java
@Component
public class DirectConsumer {

    @RabbitListener(queues = "console.queue")
    public void listenConsoleQueue(String msg) {
        System.out.println("ã€æ§åˆ¶å°æ‰“å°ã€‘æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
    }

    @RabbitListener(queues = "file.queue")
    public void listenFileQueue(String msg) {
        System.err.println("ã€å†™å…¥æ–‡ä»¶ã€‘æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
    }
}
```

### 5. æ ¸å¿ƒåŒºåˆ«å°ç»“

- **Fanout**ï¼šå¿½ç•¥ RoutingKeyï¼Œå¹¿æ’­ç»™æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—ã€‚

- **Direct**ï¼šéœ€è¦ RoutingKeyÂ **å®Œå…¨ç›¸ç­‰**ï¼Œæ‰èƒ½è·¯ç”±åˆ°å¯¹åº”é˜Ÿåˆ—ã€‚

## 05. ä¸»é¢˜æ¨¡å‹ - Topic äº¤æ¢æœº

**ç®€ä»‹**ï¼šTopic Exchange ä¸ Direct ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åŸºäº RoutingKey è¿›è¡Œè·¯ç”±ï¼Œä½†å®ƒæ”¯æŒ**é€šé…ç¬¦åŒ¹é…**ã€‚  
**è§„åˆ™**ï¼šRoutingKey é€šå¸¸æ˜¯ç”±ç‚¹Â .Â åˆ†éš”çš„å•è¯åˆ—è¡¨ï¼ˆä¾‹å¦‚Â item.insert,Â order.payment.successï¼‰ã€‚

### 1. é€šé…ç¬¦è¯¦è§£ (æ ¸å¿ƒ)

è¿™æ˜¯ Topic äº¤æ¢æœºçš„çµé­‚ï¼Œå¿…é¡»è®°æ¸…æ¥šï¼š

- **#Â (Hash)**ï¼šåŒ¹é…Â **0ä¸ªæˆ–å¤šä¸ª**Â å•è¯ã€‚
  
  - ä¾‹ï¼šitem.#Â å¯ä»¥åŒ¹é…Â item.insertã€item.insert.abcã€itemã€‚
  
  - è®°å¿†æŠ€å·§ï¼š# å·é•¿å¾—åƒæ …æ ï¼Œèƒ½åœˆä½å¾ˆå¤šä¸œè¥¿ã€‚

- ***Â (Star)**ï¼šåŒ¹é…Â **å‡†ç¡®çš„ 1 ä¸ª**Â å•è¯ã€‚
  
  - ä¾‹ï¼šitem.*Â å¯ä»¥åŒ¹é…Â item.insertï¼Œä½†**ä¸èƒ½**åŒ¹é…Â item.insert.abcã€‚

### 2. åœºæ™¯æ¨¡æ‹Ÿ

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ¶µç›–åœ°åŸŸå’Œä¸šåŠ¡çš„æ–°é—»ç³»ç»Ÿï¼š

- **Topic äº¤æ¢æœº**ï¼šitcast.topic

- **é˜Ÿåˆ— 1 (china.queue)**ï¼šå…³æ³¨æ‰€æœ‰ä¸­å›½çš„æ–°é—»ã€‚
  
  - ç»‘å®š Keyï¼šchina.#

- **é˜Ÿåˆ— 2 (news.queue)**ï¼šå…³æ³¨æ‰€æœ‰æ–°é—»ç±»ä¿¡æ¯ï¼ˆä¸ç®¡å“ªä¸ªå›½å®¶ï¼‰ã€‚
  
  - ç»‘å®š Keyï¼š*.news

**é¢„æœŸç»“æœ**ï¼š

1. å‘é€Â china.newsÂ ->Â **ä¸¤ä¸ªé˜Ÿåˆ—éƒ½èƒ½æ”¶åˆ°**ï¼ˆæ—¢æ˜¯ä¸­å›½ä¹Ÿæ˜¯æ–°é—»ï¼‰ã€‚

2. å‘é€Â china.weatherÂ ->Â **åªæœ‰é˜Ÿåˆ— 1 æ”¶åˆ°**ï¼ˆåŒ¹é…Â china.#ï¼Œä¸åŒ¹é…Â *.newsï¼‰ã€‚

3. å‘é€Â japan.newsÂ ->Â **åªæœ‰é˜Ÿåˆ— 2 æ”¶åˆ°**ï¼ˆåŒ¹é…Â *.newsï¼Œä¸åŒ¹é…Â china.#ï¼‰ã€‚

### 3. å£°æ˜é…ç½® (é…ç½®ç±»)

```java
@Configuration
public class TopicConfig {

    // 1. å£°æ˜ Topic äº¤æ¢æœº
    @Bean
    public TopicExchange topicExchange() {
        return new TopicExchange("itcast.topic");
    }

    // 2. å£°æ˜é˜Ÿåˆ—
    @Bean
    public Queue chinaQueue() { return new Queue("china.queue"); }

    @Bean
    public Queue newsQueue() { return new Queue("news.queue"); }

    // 3. ç»‘å®šå…³ç³»
    // é˜Ÿåˆ—1ï¼šåŒ¹é… china å¼€å¤´çš„æ‰€æœ‰è·¯ç”±é”®
    @Bean
    public Binding bindingChina(Queue chinaQueue, TopicExchange topicExchange) {
        return BindingBuilder.bind(chinaQueue).to(topicExchange).with("china.#");
    }

    // é˜Ÿåˆ—2ï¼šåŒ¹é…ä»»ä½•ä»¥ .news ç»“å°¾çš„å•è¯ï¼ˆå‰é¢åªèƒ½æœ‰ä¸€ä¸ªå•è¯ï¼‰
    @Bean
    public Binding bindingNews(Queue newsQueue, TopicExchange topicExchange) {
        return BindingBuilder.bind(newsQueue).to(topicExchange).with("*.news");
    }
}
```

### 4. ç”Ÿäº§è€…ä»£ç 

```java
@Test
public void testTopicExchange() {
    String exchangeName = "itcast.topic";

    // 1. å‘é€ china.news (åŒ¹é… china.# å’Œ *.news) -> ä¸¤ä¸ªé˜Ÿåˆ—éƒ½æ”¶åˆ°
    rabbitTemplate.convertAndSend(exchangeName, "china.news", "ä¸­å›½æ–°é—»å†…å®¹...");

    // 2. å‘é€ china.weather (åŒ¹é… china.#) -> åªæœ‰ china.queue æ”¶åˆ°
    rabbitTemplate.convertAndSend(exchangeName, "china.weather", "ä¸­å›½å¤©æ°”é¢„æŠ¥...");

    // 3. å‘é€ japan.news (åŒ¹é… *.news) -> åªæœ‰ news.queue æ”¶åˆ°
    rabbitTemplate.convertAndSend(exchangeName, "japan.news", "æ—¥æœ¬æ–°é—»å†…å®¹...");
}
```

### 5. æ¶ˆè´¹è€…ä»£ç 

```java
@Component
public class TopicConsumer {

    @RabbitListener(queues = "china.queue")
    public void listenChina(String msg) {
        System.out.println("ã€ä¸­å›½é¢‘é“ã€‘æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
    }

    @RabbitListener(queues = "news.queue")
    public void listenNews(String msg) {
        System.out.println("ã€ä¸–ç•Œæ–°é—»ã€‘æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
    }
}
```

### 6. æ€»ç»“

Topic äº¤æ¢æœºæå…¶å¼ºå¤§ï¼Œå®ƒå¯ä»¥æ¨¡æ‹Ÿå…¶ä»–ä¸¤ç§äº¤æ¢æœºï¼š

- å¦‚æœ BindingKey æ˜¯Â #Â -> ç›¸å½“äº Fanoutï¼ˆæ¥æ”¶æ‰€æœ‰ï¼‰ã€‚

- å¦‚æœ BindingKey ä¸­æ²¡æœ‰Â #Â å’ŒÂ *Â -> ç›¸å½“äº Directï¼ˆç²¾ç¡®åŒ¹é…ï¼‰ã€‚

- **å®æˆ˜å»ºè®®**ï¼šåœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒTopic æ˜¯ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„äº¤æ¢æœºï¼Œå› ä¸ºå®ƒæœ€å…·æ‰©å±•æ€§ã€‚

## 06. å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºçš„æ–¹å¼ (é‡è¦)

Spring AMQP æä¾›äº†ä¸¤ç§ä¸»è¦æ–¹å¼æ¥å£°æ˜ RabbitMQ çš„ç»„ä»¶ï¼š

1. **åŸºäºÂ @ConfigurationÂ é…ç½®ç±»**ï¼šç»Ÿä¸€ç®¡ç†ï¼Œé€‚åˆå®šä¹‰å¤æ‚çš„ç»‘å®šå…³ç³»ï¼ˆæˆ‘ä»¬ä¹‹å‰ç« èŠ‚ç”¨çš„éƒ½æ˜¯è¿™ç§ï¼‰ã€‚

2. **åŸºäºæ³¨è§£é©±åŠ¨ (@RabbitListener)**ï¼šç›´æ¥åœ¨æ¶ˆè´¹è€…ä¸Šå£°æ˜ï¼Œç®€å•å¿«æ·ï¼Œé€‚åˆå¾®æœåŠ¡å¼€å‘ã€‚

### æ–¹å¼ä¸€ï¼šåŸºäºÂ @ConfigurationÂ ç±» (ä¼ ç»Ÿ/é›†ä¸­å¼)

è¿™ç§æ–¹å¼å°†æ‰€æœ‰é˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šçš„å®šä¹‰æ”¾åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®ç±»ä¸­ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯**æ¸…æ™°ã€é›†ä¸­**ï¼Œç¼ºç‚¹æ˜¯å†™èµ·æ¥ç¨å¾®ç¹çã€‚

#### 1. æ ¸å¿ƒ API è¯¦è§£ (éš¾ç‚¹è§£æ)

åœ¨å®šä¹‰ Bean æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨Â QueueBuilderÂ æˆ–Â ExchangeBuilderï¼Œä¹Ÿå¯ä»¥ç›´æ¥Â newã€‚

**Queue çš„æ ¸å¿ƒå‚æ•°ï¼š**

- name: é˜Ÿåˆ—åç§°ã€‚

- durable:Â **æŒä¹…åŒ–**ã€‚é»˜è®¤ trueã€‚å¦‚æœä¸å¼€å¯ï¼ŒMQ é‡å¯åé˜Ÿåˆ—ä¼šæ¶ˆå¤±ã€‚

- exclusive:Â **æ’ä»–æ€§**ã€‚é»˜è®¤ falseã€‚å¦‚æœè®¾ä¸º trueï¼Œåˆ™è¯¥é˜Ÿåˆ—åªèƒ½è¢«å½“å‰è¿æ¥ï¼ˆConnectionï¼‰ä½¿ç”¨ï¼Œè¿æ¥æ–­å¼€é˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤ã€‚

- autoDelete:Â **è‡ªåŠ¨åˆ é™¤**ã€‚é»˜è®¤ falseã€‚å¦‚æœè®¾ä¸º trueï¼Œå½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€è¿æ¥åï¼Œé˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤ã€‚

#### 2. å®æˆ˜ä»£ç ç¤ºä¾‹

è¿™é‡Œæ¼”ç¤ºä¸€ä¸ª**ç”±ç®€å…¥ç¹**çš„é…ç½®ï¼ŒåŒ…å«å£°æ˜æ­»ä¿¡é˜Ÿåˆ—ï¼ˆé«˜çº§å‚æ•°ï¼‰çš„å†™æ³•ã€‚

```java
@Configuration
public class RabbitConfig {

    // 1. å®šä¹‰ä¸€ä¸ªç®€å•çš„ Direct äº¤æ¢æœº
    // durable=true, autoDelete=false
    @Bean
    public DirectExchange simpleDirect() {
        return new DirectExchange("simple.direct", true, false);
    }

    // 2. å®šä¹‰ä¸€ä¸ªæ™®é€šçš„æŒä¹…åŒ–é˜Ÿåˆ—
    @Bean
    public Queue simpleQueue() {
        // new Queue(name, durable, exclusive, autoDelete)
        return new Queue("simple.queue", true, false, false);
    }

    // 3. (é«˜çº§) å®šä¹‰ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„é˜Ÿåˆ— (ä¾‹å¦‚è®¾ç½® TTL æˆ– æ­»ä¿¡äº¤æ¢æœº)
    @Bean
    public Queue advancedQueue() {
        return QueueBuilder.durable("advanced.queue")
                .ttl(10000) // æ¶ˆæ¯ 10ç§’è¿‡æœŸ
                .deadLetterExchange("dlx.exchange") // ç»‘å®šæ­»ä¿¡äº¤æ¢æœº
                .deadLetterRoutingKey("dlx.key")
                .build();
    }

    // 4. ç»‘å®šå…³ç³»
    @Bean
    public Binding bindingSimple(Queue simpleQueue, DirectExchange simpleDirect) {
        return BindingBuilder.bind(simpleQueue).to(simpleDirect).with("simple.key");
    }
}
```

---

### æ–¹å¼äºŒï¼šåŸºäºæ³¨è§£é©±åŠ¨ (æ¨è/ä¾¿æºå¼)

è¿™ç§æ–¹å¼ç›´æ¥åœ¨Â @RabbitListenerÂ æ³¨è§£ä¸­å®šä¹‰ç»‘å®šå…³ç³»ã€‚å¦‚æœé˜Ÿåˆ—æˆ–äº¤æ¢æœºä¸å­˜åœ¨ï¼ŒSpring ä¼šè‡ªåŠ¨åˆ›å»ºï¼›å¦‚æœå­˜åœ¨ä¸”å±æ€§ä¸€è‡´ï¼Œåˆ™ç›´æ¥ç»‘å®šã€‚

**ä¼˜ç‚¹**ï¼šæ¶ˆè´¹è€…åœ¨å“ªé‡Œï¼Œé˜Ÿåˆ—å°±åœ¨å“ªé‡Œå£°æ˜ï¼Œä»£ç å†…èšæ€§é«˜ã€‚  
**ç¼ºç‚¹**ï¼šé…ç½®åˆ†æ•£ï¼Œå¦‚æœåŒä¸€ä¸ªé˜Ÿåˆ—è¢«å¤šä¸ªæœåŠ¡ç›‘å¬ï¼Œå®¹æ˜“é…ç½®å†²çªã€‚

#### 1. æ ¸å¿ƒæ³¨è§£ç»“æ„

ç»“æ„æ˜¯åµŒå¥—çš„ï¼š@RabbitListenerÂ ->Â @QueueBindingÂ ->Â @QueueÂ +Â @Exchangeã€‚

#### 2. å®æˆ˜ä»£ç ç¤ºä¾‹ (è¦†ç›– Direct å’Œ Topic)

```java
@Component
public class AnnotationConsumer {

    /**     * ç¤ºä¾‹ 1: å£°æ˜ Direct äº¤æ¢æœºå¹¶ç»‘å®š     * åœºæ™¯: è¿™æ˜¯ä¸€ä¸ªå¤„ç†è®¢å•çš„æ¶ˆè´¹è€…     */
    @RabbitListener(bindings = @QueueBinding(
            // 1. å£°æ˜é˜Ÿåˆ—
            value = @Queue(name = "direct.console", durable = "true", autoDelete = "false"),
            // 2. å£°æ˜äº¤æ¢æœº
            exchange = @Exchange(
                    name = "itcast.direct",
                    type = ExchangeTypes.DIRECT, // æŒ‡å®šç±»å‹ä¸º Direct
                    durable = "true"
            ),
            // 3. RoutingKey
            key = {"info", "error"}
    ))
    public void listenDirect(String msg) {
        System.out.println("Direct æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯: " + msg);
    }

    /**     * ç¤ºä¾‹ 2: å£°æ˜ Topic äº¤æ¢æœºå¹¶ç»‘å®š (æœ€å¸¸ç”¨)     * åœºæ™¯: è¿™æ˜¯ä¸€ä¸ªå¤„ç†å…·ä½“ä¸šåŠ¡é€»è¾‘çš„æ¶ˆè´¹è€…     */
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = "topic.order"),
            exchange = @Exchange(name = "itcast.topic", type = ExchangeTypes.TOPIC),
            key = "order.#" // ç›‘å¬æ‰€æœ‰ order å¼€å¤´çš„æ¶ˆæ¯
    ))
    public void listenTopic(String msg) {
        System.out.println("Topic æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯: " + msg);
    }
}
```

---

### éš¾ç‚¹ä¸æ˜“é”™ç‚¹æ€»ç»“

#### 1. å±æ€§ä¸ä¸€è‡´å¼‚å¸¸ (Precondition Failed)

è¿™æ˜¯æ–°æ‰‹æœ€å®¹æ˜“é‡åˆ°çš„å‘ã€‚

- **åœºæ™¯**ï¼šå‡è®¾ RabbitMQ ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ªåä¸ºÂ simple.queueÂ çš„é˜Ÿåˆ—ï¼Œå®ƒæ˜¯**éæŒä¹…åŒ–**çš„ã€‚

- **æ“ä½œ**ï¼šä½ åœ¨ Spring ä»£ç ä¸­æŠŠå®ƒæ”¹æˆäº†Â durable = "true"Â (æŒä¹…åŒ–) å¹¶é‡å¯é¡¹ç›®ã€‚

- **ç»“æœ**ï¼šæŠ¥é”™Â 406 PRECONDITION_FAILEDã€‚

- **åŸå› **ï¼šRabbitMQ ä¸å…è®¸é‡æ–°å®šä¹‰ä¸€ä¸ªå·²å­˜åœ¨çš„é˜Ÿåˆ—ï¼ˆé™¤éå‚æ•°å®Œå…¨ä¸€è‡´ï¼‰ã€‚

- **è§£å†³**ï¼š
  
  1. å» RabbitMQ æ§åˆ¶å°æ‰‹åŠ¨åˆ é™¤æ—§é˜Ÿåˆ—ã€‚
  
  2. æˆ–è€…ç»™æ–°é˜Ÿåˆ—æ¢ä¸ªåå­—ã€‚

#### 2. ä¸¤ç§æ–¹å¼è¯¥é€‰è°ï¼Ÿ

- **æ¨èæ–¹å¼äºŒ (æ³¨è§£)**ï¼šå¯¹äºå¤§å¤šæ•°æ™®é€šçš„ä¸šåŠ¡å¼€å‘ï¼Œç›´æ¥åœ¨æ¶ˆè´¹è€…å¤´ä¸Šå†™æ³¨è§£æœ€æ–¹ä¾¿ï¼Œæ‰€è§å³æ‰€å¾—ã€‚

- **æ¨èæ–¹å¼ä¸€ (é…ç½®ç±»)**ï¼š
  
  - å¦‚æœä½ æ˜¯**ç”Ÿäº§è€…**ï¼Œä½ éœ€è¦ç¡®ä¿å‘é€æ¶ˆæ¯å‰é˜Ÿåˆ—å·²ç»å­˜åœ¨ï¼ˆé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼‰ï¼Œä½†ä½ æ²¡æœ‰æ¶ˆè´¹è€…ä»£ç æ—¶ã€‚
  
  - å½“ç»‘å®šå…³ç³»ç‰¹åˆ«å¤æ‚ï¼Œæˆ–è€…éœ€è¦é…ç½®æ­»ä¿¡é˜Ÿåˆ— (DLX)ã€å»¶è¿Ÿé˜Ÿåˆ—ç­‰é«˜çº§ç‰¹æ€§æ—¶ï¼Œé…ç½®ç±»çœ‹èµ·æ¥æ›´æ¸…æ™°ã€‚

## 07. æ¶ˆæ¯è½¬æ¢å™¨ (Message Converter)

### 1. é»˜è®¤æƒ…å†µä¸‹çš„é—®é¢˜

åœ¨ Spring AMQP ä¸­ï¼ŒRabbitTemplateÂ çš„é»˜è®¤æ¶ˆæ¯è½¬æ¢å™¨æ˜¯Â SimpleMessageConverterï¼Œå®ƒåŸºäºÂ **JDK çš„Â ObjectOutputStream**Â è¿›è¡Œåºåˆ—åŒ–ã€‚

**å­˜åœ¨çš„é—®é¢˜ï¼š**

1. **æ•°æ®ä½“ç§¯å¤§**ï¼šJava åŸç”Ÿåºåˆ—åŒ–çš„ä½“ç§¯é€šå¸¸æ¯” JSON å¤§å¾ˆå¤šï¼Œæµªè´¹å¸¦å®½ã€‚

2. **å¯è¯»æ€§å·®**ï¼šåœ¨ RabbitMQ æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯ä½“æ—¶ï¼Œçœ‹åˆ°çš„æ˜¯ç±»ä¼¼Â \xAC\xED\x00\x05sr...Â çš„ä¹±ç ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œæ— æ³•æ ¡éªŒæ•°æ®æ­£ç¡®æ€§ã€‚

3. **å®‰å…¨æ€§ä¸å…¼å®¹æ€§**ï¼šJDK åºåˆ—åŒ–å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œä¸”è¦æ±‚æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…å¿…é¡»ä½¿ç”¨ Javaï¼Œä¸”ç±»è·¯å¾„/åŒ…åå¿…é¡»å®Œå…¨ä¸€è‡´ã€‚

**æµ‹è¯•æ¼”ç¤ºï¼š**  
å¦‚æœä½ ç›´æ¥å‘é€ä¸€ä¸ªÂ MapÂ æˆ–å¯¹è±¡ï¼š

```java
Map<String, Object> msg = new HashMap<>();
msg.put("name", "Jack");
msg.put("age", 21);
rabbitTemplate.convertAndSend("simple.queue", msg);
```

**æ§åˆ¶å°çœ‹åˆ°çš„ç»“æœ**ï¼š  
(Payload æ˜¯ä¸€å †ä¸å¯è¯»çš„äºŒè¿›åˆ¶å­—èŠ‚)

---

### 2. è§£å†³æ–¹æ¡ˆï¼šé…ç½® JSON è½¬æ¢å™¨

æˆ‘ä»¬è¦å°†é»˜è®¤çš„åºåˆ—åŒ–æ–¹å¼æ”¹ä¸ºÂ **JSON**ã€‚Spring æä¾›äº†Â Jackson2JsonMessageConverterï¼Œå¯ä»¥è‡ªåŠ¨å°† Java å¯¹è±¡è½¬æ¢æˆ JSON å­—ç¬¦ä¸²å‘é€ï¼Œæ¥æ”¶æ—¶å†è‡ªåŠ¨è½¬å› Java å¯¹è±¡ã€‚

#### 2.1 å¼•å…¥ä¾èµ–

Spring Boot çš„Â spring-boot-starter-webÂ é»˜è®¤é›†æˆäº† Jacksonã€‚å¦‚æœä½ æ˜¯çº¯æ¶ˆæ¯æœåŠ¡ï¼Œç¡®ä¿æœ‰ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

#### 2.2 é…ç½® MessageConverter

**è¿™æ˜¯æ ¸å¿ƒæ­¥éª¤**ã€‚åªéœ€è¦åœ¨**é…ç½®ç±»**ä¸­å®šä¹‰ä¸€ä¸ª Beanï¼ŒSpring Boot å°±ä¼šè‡ªåŠ¨å°†å…¶æ³¨å…¥åˆ°Â RabbitTemplateÂ ä¸­ï¼Œè¦†ç›–é»˜è®¤çš„è½¬æ¢å™¨ã€‚

> **æ³¨æ„**ï¼š**ç”Ÿäº§è€…**å’Œ**æ¶ˆè´¹è€…**éƒ½éœ€è¦é…ç½®è¿™ä¸ª Beanï¼Œå¦åˆ™ä¸€æ–¹å‘ JSONï¼Œå¦ä¸€æ–¹æŒ‰ JDK ååºåˆ—åŒ–ä¼šæŠ¥é”™ã€‚

```java
@Configuration
public class MessageConverterConfig {

    @Bean
    public MessageConverter jsonMessageConverter() {
        // ä½¿ç”¨ Jackson2JsonMessageConverter æ›¿ä»£é»˜è®¤çš„ SimpleMessageConverter
        return new Jackson2JsonMessageConverter();
    }
}
```

---

### 3. å®æˆ˜ä»£ç ï¼šå‘é€ä¸æ¥æ”¶å¯¹è±¡

#### 3.1 å®šä¹‰ä¸€ä¸ªå®ä½“ç±»

ä¸ºäº†æ¼”ç¤ºå¯¹è±¡ä¼ è¾“ï¼Œå®šä¹‰ä¸€ä¸ªç®€å•çš„Â OrderÂ ç±»ï¼ˆå¿…é¡»æœ‰ Getter/Setter æˆ– Serializableï¼ŒJackson ä¾èµ– Getter/Setterï¼‰ã€‚

```java
// ç®€å•çš„è®¢å•å®ä½“
public class Order implements Serializable {
    private String orderId;
    private Double price;
    private String name;

    // æ„é€ ã€Getterã€Setterã€ToString çœç•¥...
    public Order(String orderId, Double price, String name) {
        this.orderId = orderId;
        this.price = price;
        this.name = name;
    }
}
```

#### 3.2 ç”Ÿäº§è€…å‘é€æ¶ˆæ¯

ä»£ç å®Œå…¨ä¸ç”¨å˜ï¼convertAndSendÂ ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æˆ‘ä»¬æ³¨å…¥çš„Â jsonMessageConverterï¼Œå°†å¯¹è±¡è½¬ä¸º JSONã€‚

```java
@Test
public void testSendObject() {
    String queueName = "object.queue";

    // åˆ›å»ºå¯¹è±¡
    Order order = new Order("10086", 99.0, "iPhone 15");

    // å‘é€
    rabbitTemplate.convertAndSend(queueName, order);

    System.out.println("å¯¹è±¡æ¶ˆæ¯å‘é€æˆåŠŸï¼");
}
```

**æ­¤æ—¶åœ¨ RabbitMQ æ§åˆ¶å°æŸ¥çœ‹æ¶ˆæ¯ï¼š**

- **Payload**:Â {"orderId":"10086","price":99.0,"name":"iPhone 15"}Â (æ¸…æ™°å¯è¯»)

- **Header**:Â content_type: application/json

#### 3.3 æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯

æ¶ˆè´¹è€…æ”¶åˆ° JSON åï¼ŒSpring ä¹Ÿä¼šè‡ªåŠ¨åˆ©ç”¨è½¬æ¢å™¨å°†å…¶ååºåˆ—åŒ–ä¸ºå¯¹è±¡ã€‚

**æ–¹å¼ Aï¼šç›´æ¥æ¥æ”¶å¯¹è±¡ï¼ˆæ¨èï¼‰**  
å‚æ•°ç±»å‹ç›´æ¥å†™Â Orderï¼ŒSpring ä¼šæ ¹æ® JSON å­—æ®µè‡ªåŠ¨æ˜ å°„ã€‚

```java
@Component
public class ObjectConsumer {

    @RabbitListener(queues = "object.queue")
    public void listenOrder(Order order) {
        System.out.println("æ¥æ”¶åˆ°å¯¹è±¡æ¶ˆæ¯ï¼š" + order);
        System.out.println("è®¢å•IDï¼š" + order.getOrderId());
    }
}
```

**æ–¹å¼ Bï¼šæ¥æ”¶ Map**  
å¦‚æœä½ ä¸æƒ³å®šä¹‰å®ä½“ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨Â MapÂ æ¥æ”¶ã€‚

```java
@RabbitListener(queues = "object.queue")
public void listenMap(Map<String, Object> msg) {
    System.out.println("æ¥æ”¶åˆ° Map æ¶ˆæ¯ï¼š" + msg);
    System.out.println("ä»·æ ¼ï¼š" + msg.get("price"));
}
```

---

### 4. é«˜çº§ç»†èŠ‚ (é¢è¯•/æ’é”™ç”¨)

#### 4.1 è¿™é‡Œçš„ TypeId æ˜¯ä»€ä¹ˆï¼Ÿ

å¦‚æœä½ ä»”ç»†è§‚å¯Ÿ RabbitMQ æ§åˆ¶å°çš„æ¶ˆæ¯å±æ€§ï¼Œä¼šå‘ç° Headers é‡Œå¤šäº†ä¸€ä¸ªÂ __TypeId__Â å­—æ®µï¼Œå€¼ä¸ºÂ com.example.demo.Orderï¼ˆå…¨é™å®šç±»åï¼‰ã€‚

- **ä½œç”¨**ï¼šSpring åœ¨ååºåˆ—åŒ–æ—¶ï¼Œé»˜è®¤ä¼šå°è¯•æ ¹æ®è¿™ä¸ª TypeId å»å¯»æ‰¾å¯¹åº”çš„ Java ç±»ã€‚

- **æ½œåœ¨å‘**ï¼šå¦‚æœç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åŒ…åä¸ä¸€æ ·ï¼ˆä¾‹å¦‚ç”Ÿäº§è€…æ˜¯Â com.a.Orderï¼Œæ¶ˆè´¹è€…æ˜¯Â com.b.Orderï¼‰ï¼Œé»˜è®¤è½¬æ¢å™¨å¯èƒ½ä¼šæŠ¥é”™ã€‚

- **è§£å†³**ï¼šé€šå¸¸ JSON è½¬æ¢å™¨å¾ˆæ™ºèƒ½ï¼Œåªè¦å­—æ®µèƒ½å¯¹åº”ä¸Šï¼Œæ¶ˆè´¹è€…ç›´æ¥å†™è‡ªå·±çš„ç±»å³å¯ï¼ˆSpring ä¼šå°è¯•æ¨æ–­ï¼‰ï¼Œä½†åœ¨è·¨è¯­è¨€æˆ–å¤æ‚åœºæ™¯ä¸‹ï¼Œå»ºè®®ä½¿ç”¨Â MapÂ æˆ–è€…ç¡®ä¿ç±»ç»“æ„ä¸€è‡´ã€‚

---

# é«˜çº§ç¯‡ï¼šå¯é æ€§ã€å»¶è¿Ÿæ¶ˆæ¯ä¸ç»¼åˆæ¡ˆä¾‹

## 01. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…é‡è¿ (Producer Retry)

è¿™æ˜¯æœ€åŸºç¡€çš„ä¿æŠ¤æœºåˆ¶ã€‚
**åœºæ™¯**ï¼šä½ çš„å¾®æœåŠ¡å¯åŠ¨äº†ï¼Œä½†æ˜¯ RabbitMQ è¿˜æ²¡å¯åŠ¨ï¼Œæˆ–è€…ä¸­é—´ç½‘ç»œçªç„¶æŠ–åŠ¨äº†ä¸€ä¸‹ã€‚è¿™æ—¶å€™ç›´æ¥å‘æ¶ˆæ¯ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒæˆ–ä¸šåŠ¡ä¸­æ–­ã€‚

**è§£å†³åŠæ³•**ï¼šSpring AMQP æä¾›äº†è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆé˜»å¡å¼ï¼‰ã€‚

> **éš¾ç‚¹ç†è§£**ï¼š
> - è¿™ä¸ªâ€œé‡è¿â€**åªè§£å†³ç½‘ç»œè¿ä¸ä¸Šçš„é—®é¢˜**ï¼Œå¹¶ä¸ä¿è¯â€œæ¶ˆæ¯ä¸€å®šé€è¾¾åˆ°é˜Ÿåˆ—â€ã€‚
> - å¯ä»¥æŠŠå®ƒç†è§£æˆâ€œå¤šè¯•å‡ æ¬¡æ‰“ç”µè¯â€ï¼Œä½†æ‰“é€šä¹‹åï¼Œåé¢æ˜¯å¦çœŸçš„èŠå®Œï¼ˆå¯é æŠ•é€’ï¼‰ï¼Œè¦é åé¢çš„ Confirm/Return æœºåˆ¶ã€‚

### 1. åŸç†

å½“ RabbitTemplate å‘é€æ¶ˆæ¯å¤±è´¥ï¼ˆå› ä¸ºè¿æ¥é—®é¢˜ï¼‰æ—¶ï¼ŒSpring ä¼šè‡ªåŠ¨å°è¯•é‡æ–°å‘é€ï¼Œè€Œä¸æ˜¯ç«‹å³æŠ¥é”™ã€‚

### 2. é…ç½®å®ç°

ä½ åªéœ€è¦åœ¨ application.yml ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    # ... å…¶ä»– host, port, username, password é…ç½® ...
    template:
      retry:
        enabled: true        # å¼€å¯å¤±è´¥é‡è¯•
        initial-interval: 1000ms # ç¬¬ä¸€æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ (1ç§’)
        multiplier: 1         # é—´éš”æ—¶é—´çš„ä¹˜æ•° (1è¡¨ç¤ºå›ºå®šé—´éš”ï¼Œ2è¡¨ç¤ºé—´éš”ç¿»å€)
        max-attempts: 3       # æœ€å¤§é‡è¯•æ¬¡æ•°
```

### 3. è¿™é‡Œçš„å‘ (æ³¨æ„äº‹é¡¹)

è¿™ä¸ªé‡è¯•æœºåˆ¶æ˜¯ **é˜»å¡å¼ (Blocking)** çš„ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç½‘ç»œä¸€ç›´è¿ä¸ä¸Šï¼Œä½ çš„ä¸šåŠ¡çº¿ç¨‹ä¼šå¡åœ¨è¿™é‡Œå‚»ç­‰ 3 ç§’ï¼ˆ1s * 3æ¬¡ï¼‰ã€‚

- **å»ºè®®**ï¼šè¯¥åŠŸèƒ½åªç”¨äºå¤„ç†**ç¬é—´çš„ç½‘ç»œæŠ–åŠ¨**ã€‚å¦‚æœé‡è¯•å¤šæ¬¡è¿˜æ²¡æˆåŠŸï¼Œè¯´æ˜ç½‘ç»œçœŸæ–­äº†ï¼Œåº”è¯¥å¿«é€Ÿå¤±è´¥ï¼Œä¸è¦è®©ä¸šåŠ¡çº¿ç¨‹ä¸€ç›´å¡æ­»ã€‚

------



## 02. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…ç¡®è®¤åŸç†

ä¸Šé¢çš„é‡è¯•è§£å†³äº†â€œè¿ä¸ä¸Šâ€çš„é—®é¢˜ï¼Œä½†å¦‚æœâ€œè¿ä¸Šäº†â€ï¼Œæ¶ˆæ¯å‘å‡ºå»äº†ï¼ŒRabbitMQ åˆ°åº•æ”¶æ²¡æ”¶åˆ°å‘¢ï¼Ÿ

RabbitMQ æä¾›äº†ä¸¤å±‚ç¡®è®¤æœºåˆ¶æ¥å›ç­”è¿™ä¸ªé—®é¢˜ï¼š

> **éš¾ç‚¹ç†è§£ï¼šä¸¤è·³ç¡®è®¤**  
> - ç¬¬ 1 è·³ï¼š**ç”Ÿäº§è€… -> äº¤æ¢æœº**ï¼Œç”¨ ConfirmCallbackï¼Œçœ‹çš„æ˜¯â€œäº¤æ¢æœºæ”¶æ²¡æ”¶åˆ°â€ã€‚  
> - ç¬¬ 2 è·³ï¼š**äº¤æ¢æœº -> é˜Ÿåˆ—**ï¼Œç”¨ ReturnCallbackï¼Œçœ‹çš„æ˜¯â€œæœ‰æ²¡æœ‰æˆåŠŸè·¯ç”±åˆ°é˜Ÿåˆ—â€ã€‚  
> - ç¢°åˆ°â€œæ¶ˆæ¯ä¸¢å“ªå„¿äº†ï¼Ÿâ€æ—¶ï¼Œä¼˜å…ˆé—®è‡ªå·±ï¼š**æ˜¯æ²¡åˆ°äº¤æ¢æœºï¼Œè¿˜æ˜¯åˆ°äº†äº¤æ¢æœºä½†æ²¡è¿›ä»»ä½•é˜Ÿåˆ—ï¼Ÿ**

### 1. ConfirmCallback (å‘å¸ƒç¡®è®¤)

**ç›‘æ§èŒƒå›´**ï¼šç”Ÿäº§è€… -> äº¤æ¢æœº (Exchange)

- **Ack (Success)**ï¼šæ¶ˆæ¯æˆåŠŸåˆ°è¾¾äº†äº¤æ¢æœºã€‚
- **Nack (Failure)**ï¼šæ¶ˆæ¯æ²¡æœ‰åˆ°è¾¾äº¤æ¢æœºï¼ˆæ¯”å¦‚äº¤æ¢æœºåå­—å†™é”™äº†ï¼Œæˆ–è€… MQ å†…éƒ¨å‡ºé”™ï¼‰ã€‚

### 2. ReturnCallback (æ¶ˆæ¯å›é€€)

**ç›‘æ§èŒƒå›´**ï¼šäº¤æ¢æœº -> é˜Ÿåˆ— (Queue)

- **è§¦å‘æ¡ä»¶**ï¼šæ¶ˆæ¯åˆ°äº†äº¤æ¢æœºï¼Œä½†æ˜¯**æ²¡æœ‰è·¯ç”±åˆ°ä»»ä½•ä¸€ä¸ªé˜Ÿåˆ—**ï¼ˆæ¯”å¦‚ RoutingKey å†™é”™äº†ï¼Œæˆ–è€…é˜Ÿåˆ—ä¸å­˜åœ¨ï¼‰ã€‚
- è¿™æ—¶å€™ï¼Œäº¤æ¢æœºä¼šæŠŠæ¶ˆæ¯â€œé€€å›â€ç»™ç”Ÿäº§è€…ï¼Œå‘Šè¯‰å®ƒï¼šâ€œæˆ‘æ”¶åˆ°äº†ï¼Œä½†æˆ‘æ‰¾ä¸åˆ°è·¯ã€‚â€

------



## 03. ç”Ÿäº§è€…å¯é æ€§ - ç”Ÿäº§è€…ç¡®è®¤ä»£ç å®ç°

è¿™æ˜¯ä¸€ä¸ªé«˜é¢‘é¢è¯•ç‚¹ï¼Œä¹Ÿæ˜¯å®æˆ˜ä¸­çš„éš¾ç‚¹ã€‚æˆ‘ä»¬éœ€è¦é…ç½® Spring Boot æ¥ç›‘å¬è¿™ä¸¤ä¸ªå›è°ƒã€‚

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶

é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQ æ˜¯ä¸ºäº†æ€§èƒ½ï¼Œå‘å®Œå°±ä¸ç®¡äº†ã€‚è¦å¼€å¯ç¡®è®¤ï¼Œå¿…é¡»é…ç½®ï¼š

```yaml
spring:
  rabbitmq:
    # 1. å¼€å¯å‘é€è€…ç¡®è®¤ (Publisher Confirms)
    # simple: åŒæ­¥ç­‰å¾…ç¡®è®¤ (æ€§èƒ½å·®)
    # correlated: å¼‚æ­¥å›è°ƒç¡®è®¤ (æ¨è)
    publisher-confirm-type: correlated
    
    # 2. å¼€å¯æ¶ˆæ¯å›é€€ (Publisher Returns)
    # ä¹Ÿå°±æ˜¯å½“æ¶ˆæ¯è·¯ç”±å¤±è´¥æ—¶ï¼Œæ˜¯å¦è¦æŠŠæ¶ˆæ¯é€€å›ç»™ç”Ÿäº§è€…
    publisher-returns: true
```

### ç¬¬äºŒæ­¥ï¼šé…ç½®å›è°ƒå‡½æ•° (CommonConfig)

æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼Œç»™ RabbitTemplate è®¾ç½®ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼ˆCallbackï¼‰ã€‚

**æ³¨æ„**ï¼šæ¯ä¸ªé¡¹ç›®åªèƒ½é…ç½®ä¸€æ¬¡ï¼Œå»ºè®®åœ¨é¡¹ç›®å¯åŠ¨æ—¶ç»Ÿä¸€é…ç½®ã€‚

```java
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.ReturnedMessage;
import org.springframework.amqp.rabbit.connection.CorrelationData;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.context.annotation.Configuration;

@Slf4j
@Configuration
public class CommonConfig implements ApplicationContextAware {

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        // 1. è·å– RabbitTemplate
        RabbitTemplate rabbitTemplate = applicationContext.getBean(RabbitTemplate.class);

        // 2. è®¾ç½® ConfirmCallback (æ¶ˆæ¯å‘åˆ°äº¤æ¢æœºäº†å—ï¼Ÿ)
        rabbitTemplate.setConfirmCallback(new RabbitTemplate.ConfirmCallback() {
            @Override
            public void confirm(CorrelationData correlationData, boolean ack, String cause) {
                // correlationData: æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯† (åé¢å‘é€æ—¶ä¼šè®²)
                // ack: true ä»£è¡¨æˆåŠŸ, false ä»£è¡¨å¤±è´¥
                // cause: å¤±è´¥åŸå› 
                
                //ä»¥æ­¤åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸï¼Œå¦‚æœå¤±è´¥ï¼Œå¯ä»¥è®°å½•æ—¥å¿—æˆ–é‡å‘
                String id = (correlationData != null) ? correlationData.getId() : "æœªçŸ¥ID";
                if (ack) {
                    log.info("æ¶ˆæ¯å‘é€æˆåŠŸï¼ŒID: {}", id);
                } else {
                    log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼ŒID: {}ï¼ŒåŸå› : {}", id, cause);
                    // è¡¥æ•‘æªæ–½ï¼šé‡å‘æ¶ˆæ¯ / è®°å½•æ•°æ®åº“ç­‰å¾…äººå·¥å¤„ç†
                }
            }
        });

        // 3. è®¾ç½® ReturnsCallback (æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—äº†å—ï¼Ÿ)
        // æ³¨æ„ï¼šåªæœ‰è·¯ç”±å¤±è´¥æ—¶æ‰ä¼šè§¦å‘è¿™ä¸ªå›è°ƒ
        rabbitTemplate.setReturnsCallback(new RabbitTemplate.ReturnsCallback() {
            @Override
            public void returnedMessage(ReturnedMessage returned) {
                log.error("æ¶ˆæ¯è¢«é€€å›ï¼");
                log.error("Exchange: {}", returned.getExchange());
                log.error("RoutingKey: {}", returned.getRoutingKey());
                log.error("Msg: {}", returned.getMessage());
                log.error("ReplyCode: {}", returned.getReplyCode()); // é”™è¯¯ç 
                // è¡¥æ•‘æªæ–½ï¼šæ£€æŸ¥ RoutingKey æ˜¯å¦å†™é”™ï¼Œæˆ–è€…é˜Ÿåˆ—æ˜¯å¦æœªç»‘å®š
            }
        });
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šå‘é€æ¶ˆæ¯ (æºå¸¦ CorrelationData)

åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ç»™æ¶ˆæ¯å¸¦ä¸Šä¸€ä¸ªâ€œèº«ä»½è¯â€ï¼ˆCorrelationDataï¼‰ï¼Œè¿™æ ·åœ¨å›è°ƒå‡½æ•°é‡Œæˆ‘ä»¬æ‰èƒ½çŸ¥é“æ˜¯**å“ªä¸€æ¡**æ¶ˆæ¯æˆåŠŸæˆ–å¤±è´¥äº†ã€‚

```java
@Test
public void testConfirm() {
    // 1. å‡†å¤‡æ¶ˆæ¯
    String exchangeName = "itcast.direct"; 
    String msg = "Hello, Confirm!";
    
    // 2. å‡†å¤‡ CorrelationData (æ¶ˆæ¯çš„å”¯ä¸€ID)
    // å®é™…å¼€å‘ä¸­é€šå¸¸ä½¿ç”¨ UUID æˆ– è®¢å•ID
    CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
    
    // 3. å‘é€æ¶ˆæ¯
    rabbitTemplate.convertAndSend(exchangeName, "info", msg, correlationData);
    
    System.out.println("å‘é€å®Œæ¯•ï¼Œç­‰å¾…å›è°ƒ...");
    
    // ç”±äºæ˜¯å¼‚æ­¥å›è°ƒï¼Œä¸ºäº†èƒ½çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºï¼Œç¡ä¸€ä¼šå„¿
    try { Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); }
}
```

### ç¬¬å››æ­¥ï¼šå„ç§æƒ…å†µçš„æµ‹è¯•ç»“æœ

ä¸ºäº†è®©ä½ å½»åº•ç†è§£ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸‰ç§æƒ…å†µï¼š

1. **æ­£å¸¸æƒ…å†µ**ï¼š
   - äº¤æ¢æœºå­˜åœ¨ï¼Œé˜Ÿåˆ—å­˜åœ¨ï¼ŒRoutingKey æ­£ç¡®ã€‚
   - **ç»“æœ**ï¼šè§¦å‘ ConfirmCallback(ack=true)ã€‚
2. **äº¤æ¢æœºåé”™è¯¯** (å‘é€ç»™ä¸€ä¸ªä¸å­˜åœ¨çš„äº¤æ¢æœº hmall.wrong)ï¼š
   - **ç»“æœ**ï¼šè§¦å‘ ConfirmCallback(ack=false)ã€‚
   - **åŸå› **ï¼šæ¶ˆæ¯è¿äº¤æ¢æœºå¤§é—¨éƒ½æ²¡è¿›å»ï¼ŒæŠ¥é”™â€œno exchangeâ€ã€‚
3. **è·¯ç”±å¤±è´¥** (äº¤æ¢æœºå¯¹ï¼Œä½† RoutingKey é”™ï¼Œæˆ–è€…æ²¡ç»‘é˜Ÿåˆ—)ï¼š
   - **ç»“æœ**ï¼š
     1. å…ˆè§¦å‘ ReturnsCallback (è¢«é€€å›äº†)ã€‚
     2. å†è§¦å‘ ConfirmCallback(ack=true)ã€‚
   - **ç†è§£(éš¾ç‚¹)**ï¼šä¸ºä»€ä¹ˆ ack æ˜¯ trueï¼Ÿå› ä¸º MQ å‘Šè¯‰ä½ ï¼šâ€œäº¤æ¢æœºç¡®å®æ”¶åˆ°æ¶ˆæ¯äº†ï¼ˆAckï¼‰ï¼Œåªæ˜¯äº¤æ¢æœºæ²¡åœ°æ–¹é€ï¼Œæ‰€ä»¥ç»™ä½ é€€å›æ¥äº†ï¼ˆReturnï¼‰ã€‚â€

**ç¬¬ä¸€éƒ¨åˆ†æ€»ç»“**ï¼š

- **ç”Ÿäº§è€…é‡è¿**ï¼šè§£å†³ç½‘ç»œè¿ä¸ä¸Šçš„é—®é¢˜ï¼ˆé˜»å¡å¼ï¼Œæ…ç”¨ï¼‰ã€‚
- **ConfirmCallback**ï¼šè§£å†³æ¶ˆæ¯æ²¡åˆ°äº¤æ¢æœºçš„é—®é¢˜ã€‚
- **ReturnsCallback**ï¼šè§£å†³æ¶ˆæ¯åˆ°äº†äº¤æ¢æœºä½†æ²¡åˆ°é˜Ÿåˆ—çš„é—®é¢˜ã€‚

------



## 04. MQ çš„å¯é æ€§ - æ•°æ®æŒä¹…åŒ– (Data Persistence)

**æ ¸å¿ƒé—®é¢˜**ï¼šå³ä½¿ç”Ÿäº§è€…æˆåŠŸæŠŠæ¶ˆæ¯å‘åˆ°äº†äº¤æ¢æœºï¼Œäº¤æ¢æœºä¹ŸæˆåŠŸè·¯ç”±åˆ°äº†é˜Ÿåˆ—ï¼Œä½†å¦‚æœæ­¤æ—¶ **RabbitMQ æœåŠ¡å™¨çªç„¶æ–­ç”µã€é‡å¯æˆ–è€…å®•æœº**ï¼Œå†…å­˜é‡Œçš„æ¶ˆæ¯æ˜¯ä¸æ˜¯å…¨æ²¡äº†ï¼Ÿ

ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åšä¸¤ä»¶äº‹ï¼š

1. **æŒä¹…åŒ–**ï¼šæŠŠæ•°æ®å†™åˆ°ç£ç›˜é‡Œï¼Œé‡å¯åè¿˜åœ¨ã€‚
2. **Lazy Queue**ï¼šåº”å¯¹æµ·é‡æ¶ˆæ¯ç§¯å‹ï¼Œé˜²æ­¢å†…å­˜æ’‘çˆ†ã€‚

RabbitMQ çš„æŒä¹…åŒ–åˆ†ä¸ºä¸‰ä¸ªå±‚é¢ï¼Œç¼ºä¸€ä¸å¯ï¼š

1. **äº¤æ¢æœºæŒä¹…åŒ–**
2. **é˜Ÿåˆ—æŒä¹…åŒ–**
3. **æ¶ˆæ¯æŒä¹…åŒ–**

> **éš¾ç‚¹ç†è§£ï¼šä¸ºä»€ä¹ˆâ€œä¸‰ä»¶å¥—â€ç¼ºä¸€ä¸å¯ï¼Ÿ**  
> - åªæŒä¹…åŒ–æ¶ˆæ¯ã€ä¸æŒä¹…åŒ–é˜Ÿåˆ—ï¼š**é‡å¯åé˜Ÿåˆ—æ²¡äº†**ï¼Œå“ªæ€•ç£ç›˜ä¸Šæœ‰æ¶ˆæ¯ï¼Œä¹Ÿæ‹¿ä¸åˆ°ï¼ˆç­‰äºä¸¢äº†ï¼‰ã€‚  
> - åªæŒä¹…åŒ–é˜Ÿåˆ—ã€ä¸æŒä¹…åŒ–æ¶ˆæ¯ï¼š**é‡å¯åé˜Ÿåˆ—åœ¨ï¼Œä½†æ¶ˆæ¯å…¨ç©ºäº†**ã€‚  
> - æ‰€ä»¥çœŸæ­£å®‰å…¨çš„åšæ³•æ˜¯ï¼š**äº¤æ¢æœº + é˜Ÿåˆ— + æ¶ˆæ¯éƒ½æŒä¹…åŒ–**ï¼Œæ‰èƒ½ä¿è¯â€œé‡å¯ä¸ä¸¢ & èƒ½æ­£å¸¸ç»§ç»­æŠ•é€’â€ã€‚

### 1. äº¤æ¢æœºæŒä¹…åŒ–

åœ¨å£°æ˜äº¤æ¢æœºæ—¶ï¼ŒæŒ‡å®š durable = trueã€‚
å¦‚æœäº¤æ¢æœºä¸æŒä¹…åŒ–ï¼ŒMQ é‡å¯åï¼Œè¿™ä¸ªäº¤æ¢æœºå°±ä¼šæ¶ˆå¤±ï¼Œåç»­å‘ç»™å®ƒçš„æ¶ˆæ¯ä¼šæŠ¥é”™ã€‚

**Spring Boot ä»£ç å®ç°ï¼š**

```java
@Configuration
public class PersistenceConfig {

    @Bean
    public DirectExchange durableExchange() {
        // æ„é€ å‡½æ•°ï¼šname, durable(æ˜¯å¦æŒä¹…åŒ–), autoDelete(æ˜¯å¦è‡ªåŠ¨åˆ é™¤)
        // é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring çš„ new DirectExchange() ä¹Ÿæ˜¯ durable=true çš„
        return new DirectExchange("simple.direct", true, false);
    }
}
```

### 2. é˜Ÿåˆ—æŒä¹…åŒ–

åœ¨å£°æ˜é˜Ÿåˆ—æ—¶ï¼ŒæŒ‡å®š durable = trueã€‚
å¦‚æœä¸æŒä¹…åŒ–ï¼ŒMQ é‡å¯åï¼Œé˜Ÿåˆ—ä¼šæ¶ˆå¤±ï¼Œé‡Œé¢å³ä½¿æœ‰æŒä¹…åŒ–çš„æ¶ˆæ¯ä¹Ÿä¼šä¸€èµ·ä¸¢ã€‚

**Spring Boot ä»£ç å®ç°ï¼š**

```java
@Bean
public Queue durableQueue() {
    // æ„é€ å‡½æ•°ï¼šname, durable
    // é»˜è®¤ new Queue("name") å°±æ˜¯ durable=true
    return new Queue("simple.queue", true); 
}
```

### 3. æ¶ˆæ¯æŒä¹…åŒ– (é‡ç‚¹)

å°±ç®—äº¤æ¢æœºå’Œé˜Ÿåˆ—éƒ½åœ¨ï¼Œå¦‚æœæ¶ˆæ¯æœ¬èº«æ˜¯â€œå†…å­˜æ¶ˆæ¯â€ï¼Œé‡å¯åæ¶ˆæ¯ä¾ç„¶ä¼šä¸¢å¤±ã€‚
æ¶ˆæ¯æŒä¹…åŒ–æ˜¯æŒ‡ï¼šæ¶ˆæ¯åœ¨å‘é€æ—¶ï¼Œæ ‡è®°ä¸º delivery_mode = 2 (Persistent)ï¼ŒMQ ä¼šå°†å…¶å†™å…¥ç£ç›˜ã€‚

**Spring Boot çš„é»˜è®¤è¡Œä¸ºï¼š**
å¥½æ¶ˆæ¯ï¼**Spring AMQP çš„ RabbitTemplate é»˜è®¤å‘é€çš„æ¶ˆæ¯å°±æ˜¯æŒä¹…åŒ–çš„ã€‚**

**æºç è¯æ˜**ï¼š
Spring åœ¨ convertAndSend æ—¶ï¼Œä¼šè‡ªåŠ¨è®¾ç½® MessagePropertiesï¼Œå…¶ä¸­ deliveryMode é»˜è®¤ä¸º MessageDeliveryMode.PERSISTENTã€‚

**ä»£ç æ¼”ç¤º (å¦‚ä½•æ‰‹åŠ¨æ§åˆ¶ï¼Œè™½ç„¶å¾ˆå°‘ç”¨åˆ°)ï¼š**

```java
@Test
public void testDurableMessage() {
    Message message = MessageBuilder
            .withBody("è¿™å°±å«æŒä¹…åŒ–æ¶ˆæ¯".getBytes(StandardCharsets.UTF_8))
            .setDeliveryMode(MessageDeliveryMode.PERSISTENT) // æŒä¹…åŒ–
            // .setDeliveryMode(MessageDeliveryMode.NON_PERSISTENT) // éæŒä¹…åŒ–(å†…å­˜)
            .build();

    rabbitTemplate.convertAndSend("simple.queue", message);
}
```

------



## 05. MQ çš„å¯é æ€§ - Lazy Queue (æƒ°æ€§é˜Ÿåˆ—)

**åœºæ™¯æè¿°**ï¼š
å‡è®¾æ¶ˆè´¹è€…æŒ‚äº†ï¼Œä½†æ˜¯ç”Ÿäº§è€…è¿˜åœ¨ç–¯ç‹‚å‘æ¶ˆæ¯ã€‚

- **æ™®é€šé˜Ÿåˆ—**ï¼šä¼šå°½åŠ›æŠŠæ¶ˆæ¯å­˜ä»å†…å­˜ï¼ˆRAMï¼‰é‡Œï¼Œä¸ºäº†å¿«ã€‚å¦‚æœæ¶ˆæ¯å¤ªå¤šï¼Œå†…å­˜æ»¡äº†ï¼ŒRabbitMQ ä¼šæš‚åœæ¥æ”¶æ¶ˆæ¯ï¼Œå¼€å§‹æŠŠå†…å­˜é‡Œçš„æ¶ˆæ¯â€œæ¢é¡µï¼ˆPage Outï¼‰â€åˆ°ç£ç›˜ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šé˜»å¡é˜Ÿåˆ—ï¼Œå¯¼è‡´æ€§èƒ½å‰§çƒˆä¸‹é™ï¼ˆStop-the-worldï¼‰ã€‚
- **é£é™©**ï¼šå¦‚æœç§¯å‹äº†å‡ ç™¾ä¸‡æ¡æ¶ˆæ¯ï¼ŒRabbitMQ å¯èƒ½ä¼šç”± OOM (Out Of Memory) å¯¼è‡´å´©æºƒã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ **Lazy Queue**ã€‚
Lazy Queue ä» 3.6.0 ç‰ˆæœ¬å¼•å…¥ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ï¼š

1. **ç›´æ¥å­˜ç£ç›˜**ï¼šæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œç›´æ¥å†™å…¥ç£ç›˜ï¼Œä¸å†ç»è¿‡å†…å­˜ã€‚
2. **å†…å­˜å ç”¨æä½**ï¼šå†…å­˜é‡Œåªå­˜ç´¢å¼•ï¼Œä¸å­˜æ•°æ®ã€‚
3. **è¯»å–æ‰åŠ è½½**ï¼šåªæœ‰å½“æ¶ˆè´¹è€…æ¥å–æ¶ˆæ¯æ—¶ï¼Œæ‰ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ã€‚

**é€‚ç”¨åœºæ™¯**ï¼šæ‰€æœ‰å¯èƒ½å‘ç”Ÿ**æµ·é‡æ¶ˆæ¯å †ç§¯**çš„é˜Ÿåˆ—ï¼ˆæ¯”å¦‚ç§’æ€å‰Šå³°ã€æ—¥å¿—å †ç§¯ï¼‰ã€‚

### 1. ä»£ç å®ç° (å£°æ˜ Lazy Queue)

åœ¨ Spring Boot ä¸­ï¼Œé€šè¿‡ QueueBuilder æˆ–æ³¨è§£å‚æ•°è®¾ç½® x-queue-mode = lazyã€‚

**æ–¹å¼ä¸€ï¼šåŸºäº @Bean é…ç½®**

```java
@Bean
public Queue lazyQueue() {
    return QueueBuilder.durable("lazy.queue")
            .lazy() // å…³é”®ï¼šå¼€å¯ Lazy æ¨¡å¼
            .build();
}
```

**æ–¹å¼äºŒï¼šåŸºäºæ³¨è§£**

```java
@RabbitListener(queuesToDeclare = @Queue(
        name = "lazy.queue",
        durable = "true",
        arguments = @Argument(name = "x-queue-mode", value = "lazy") // å…³é”®é…ç½®
))
public void listenLazyQueue(String msg) {
    System.out.println("æ¥æ”¶åˆ°æƒ°æ€§æ¶ˆæ¯ï¼š" + msg);
}
```

### 2. æ€§èƒ½å¯¹æ¯”

- **æ™®é€šé˜Ÿåˆ—**ï¼šå‘é€é€Ÿåº¦å¿«ï¼Œä½†å¦‚æœæœ‰å‡ äº¿æ¡ç§¯å‹ï¼Œæ€§èƒ½ä¼šé›ªå´©ã€‚
- **Lazy Queue**ï¼šå‘é€é€Ÿåº¦å—é™äºç£ç›˜ IOï¼ˆç¨å¾®æ…¢ä¸€ç‚¹ç‚¹ï¼‰ï¼Œä½†æå…¶ç¨³å®šï¼Œæ”¯æŒæ•°äº¿çº§æ¶ˆæ¯ç§¯å‹ï¼Œä¸ä¼šæŠŠ MQ æ’‘çˆ†ã€‚

------

**ç¬¬äºŒéƒ¨åˆ†æ€»ç»“**ï¼š

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»ä¿è¯äº†ï¼š

1. **ç”Ÿäº§è€… -> MQ**ï¼šé€šè¿‡ Confirm/Return æœºåˆ¶ä¿è¯å‘åˆ°äº†ã€‚
2. **MQ è‡ªèº«**ï¼šé€šè¿‡æŒä¹…åŒ–ä¿è¯é‡å¯ä¸ä¸¢ï¼Œé€šè¿‡ Lazy Queue ä¿è¯ç§¯å‹ä¸å´©ã€‚

æ¥ä¸‹æ¥å°±æ˜¯æœ€åä¸€æ­¥ï¼š**æ¶ˆæ¯å‘ç»™æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…å¤„ç†å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ**

## 06. æ¶ˆè´¹è€…å¯é æ€§ - æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ (Consumer Acknowledgement)

**åœºæ™¯**ï¼šæ¶ˆè´¹è€…ä»£ç å†™äº† Bugï¼ˆæ¯”å¦‚ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼‰ï¼Œæˆ–è€…æ•°æ®åº“è¿ä¸ä¸Šäº†ã€‚

- å¦‚æœ MQ è®¤ä¸ºä½ å¤„ç†å®Œäº†ï¼ˆè‡ªåŠ¨ Ackï¼‰ï¼Œæ¶ˆæ¯å°±ä¸¢äº†ã€‚
- å¦‚æœ MQ è®¤ä¸ºä½ æ²¡å¤„ç†å®Œï¼ˆNackï¼‰ï¼Œå®ƒä¼šä¸åœåœ°ç»™ä½ é‡å‘ï¼Œå¯¼è‡´ä½ çš„ç¨‹åºè¿›å…¥**æ­»å¾ªç¯**ï¼Œæ—¥å¿—çˆ†æ»¡ï¼ŒCPU é£™å‡ã€‚

RabbitMQ éœ€è¦çŸ¥é“æ¶ˆè´¹è€…æœ‰æ²¡æœ‰æˆåŠŸæŠŠæ¶ˆæ¯åƒæ‰ã€‚Spring AMQP æä¾›äº†ä¸‰ç§ç¡®è®¤æ¨¡å¼ã€‚

> **éš¾ç‚¹ç†è§£ï¼šauto / none / manual æ€ä¹ˆé€‰ï¼Ÿ**  
> - `none`ï¼šMQ ä¸€å‘å°±å½“ä½ åƒå®Œäº†ï¼Œ**æœ€å±é™©**ï¼Œé™¤éæ˜¯å®Œå…¨ä¸é‡è¦çš„æ—¥å¿—ã€‚  
> - `manual`ï¼šä½ è‡ªå·±å†™ `channel.basicAck()`ï¼Œ**æœ€çµæ´»ä½†ä¹Ÿæœ€å®¹æ˜“å†™é”™**ã€‚  
> - `auto`ï¼š**æ¨è**ï¼Œè®© Spring æ ¹æ®â€œä½ æœ‰æ²¡æœ‰æŠ›å¼‚å¸¸â€æ¥å¸®ä½ å†³å®š Ack / Nack / Rejectï¼Œç„¶åå†é…åˆåé¢çš„â€œæœ¬åœ°é‡è¯• + é”™è¯¯é˜Ÿåˆ—â€æ–¹æ¡ˆå…œåº•ã€‚

### 1. ä¸‰ç§æ¨¡å¼é…ç½® (application.yml)

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: auto  # å¯é€‰å€¼: none, manual, auto (é»˜è®¤)
```

### 2. æ¨¡å¼è¯¦è§£

- **none (è‡ªåŠ¨ç¡®è®¤/è§†æ­»å¦‚å½’)**
  - **é€»è¾‘**ï¼šæ¶ˆæ¯ä¸€æ—¦æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼ŒMQ é©¬ä¸Šå°±æŠŠæ¶ˆæ¯åˆ äº†ï¼Œä¸ç®¡ä½ ä»£ç æŠ¥ä¸æŠ¥é”™ã€‚
  - **åæœ**ï¼šå¦‚æœä½ ä»£ç æŠ›å¼‚å¸¸ï¼Œæ¶ˆæ¯ç›´æ¥ä¸¢å¤±ã€‚**ä¸æ¨èä½¿ç”¨**ã€‚
- **manual (æ‰‹åŠ¨ç¡®è®¤/ç²¾ç»†æ§åˆ¶)**
  - **é€»è¾‘**ï¼šéœ€è¦åœ¨ä»£ç é‡Œæ‰‹åŠ¨è°ƒç”¨ channel.basicAck() æˆ– channel.basicReject()ã€‚
  - **åæœ**ï¼šä»£ç ä¾µå…¥æ€§å¤ªå¼ºï¼Œå†™èµ·æ¥å¾ˆéº»çƒ¦ï¼Œå®¹æ˜“æ¼å†™å¯¼è‡´æ¶ˆæ¯å †ç§¯ã€‚
  - **åœºæ™¯**ï¼šé™¤éä¸šåŠ¡é€»è¾‘æå…¶ç‰¹æ®Šï¼Œå¦åˆ™**ä¸€èˆ¬ä¸ç”¨**ã€‚
- **auto (è‡ªåŠ¨æ¨æ–­/æ¨èæ¨¡å¼)**
  - **é€»è¾‘**ï¼šSpring æ ¹æ®ä½ çš„ä¸šåŠ¡é€»è¾‘æ˜¯å¦æŠ›å‡ºå¼‚å¸¸æ¥åˆ¤æ–­ã€‚
    - **æ— å¼‚å¸¸** -> è¿”å› Ack (MQ åˆ é™¤æ¶ˆæ¯)ã€‚
    - **æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸** -> è¿”å› Nack (MQ é‡æ–°æŠ•é€’)ã€‚
    - **æŠ›å‡ºæ¶ˆæ¯è½¬æ¢å¼‚å¸¸** (å¦‚ JSON æ ¼å¼ä¸å¯¹) -> è¿”å› Reject (MQ åˆ é™¤æ¶ˆæ¯ï¼Œå› ä¸ºé‡è¯•ä¹Ÿæ²¡ç”¨)ã€‚
  - **ç»“è®º**ï¼šç»å¤§å¤šæ•°æƒ…å†µç›´æ¥ç”¨ **auto**ã€‚

### 3. auto æ¨¡å¼çš„è‡´å‘½é—®é¢˜

å¦‚æœåœ¨ auto æ¨¡å¼ä¸‹ï¼Œä½ çš„ä»£ç ä¸€ç›´æŠ›å¼‚å¸¸ï¼ˆæ¯”å¦‚æ•°æ®åº“æŒ‚äº†ï¼‰ï¼ŒSpring ä¼šä¸€ç›´è¿”å› Nackï¼ŒMQ å°±ä¼šä¸€ç›´é‡å‘æ¶ˆæ¯ã€‚
**ç»“æœ**ï¼šæ¶ˆæ¯åœ¨ MQ å’Œæ¶ˆè´¹è€…ä¹‹é—´æ— é™å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯**æ­»å¾ªç¯**ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ **Spring çš„æœ¬åœ°é‡è¯•æœºåˆ¶**ã€‚

## 07. æ¶ˆè´¹è€…å¯é æ€§ - å¤±è´¥é‡è¯•æœºåˆ¶ (Failure Retry)

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆè´¹è€…å¤„ç†å¤±è´¥æ—¶ï¼Œ**ä¸è¦ç«‹å³è¿”ç»™ MQ**ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°ï¼ˆJVM å†…å­˜é‡Œï¼‰å¤šé‡è¯•å‡ æ¬¡ã€‚å¦‚æœå‡ æ¬¡éƒ½å¤±è´¥äº†ï¼Œå†ç”± Spring å†³å®šæ€ä¹ˆå¤„ç†ï¼ˆæ˜¯ä¸¢å¼ƒè¿˜æ˜¯å‘ç»™ä¸“é—¨çš„æŠ¥é”™é˜Ÿåˆ—ï¼‰ã€‚

> **éš¾ç‚¹ç†è§£ï¼šæœ¬åœ°é‡è¯• vs MQ é‡å‘**  
> - æ²¡æœ‰è¿™ä¸€èŠ‚æ—¶ï¼šauto æ¨¡å¼ä¸‹ä¸€ç›´æŠ›å¼‚å¸¸ï¼ŒMQ å°±ä¼šâ€œä¸€ç›´é‡æ–°æŠ•é€’åŒä¸€æ¡æ¶ˆæ¯â€ï¼Œå½¢æˆ**MQ <-> æ¶ˆè´¹è€…ä¹‹é—´çš„æ­»å¾ªç¯**ã€‚  
> - æœ‰äº†æœ¬åœ°é‡è¯•ï¼šå¤±è´¥å…ˆåœ¨**å½“å‰ JVM å†…éƒ¨**å¤šè¯•å‡ æ¬¡ï¼Œå®åœ¨ä¸è¡Œå†äº¤ç»™ MessageRecoverer å†³å®šâ€œä¸¢å¼ƒè¿˜æ˜¯å‘åˆ°é”™è¯¯é˜Ÿåˆ—â€ï¼Œ**ä¸å†è®© MQ æ— é™é‡å‘**ã€‚

### 1. å¼€å¯æœ¬åœ°é‡è¯• (é…ç½® YAML)

è¿™æ˜¯è§£å†³â€œæ­»å¾ªç¯â€çš„ç¬¬ä¸€æ­¥ã€‚

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        retry:
          enabled: true           # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•
          initial-interval: 1000ms # ç¬¬ä¸€æ¬¡é‡è¯•ç­‰å¾… 1ç§’
          multiplier: 1           # ç­‰å¾…æ—¶é—´çš„å€æ•°
          max-attempts: 3         # æœ€å¤§é‡è¯•æ¬¡æ•° (åŒ…å«ç¬¬ä¸€æ¬¡)
          stateless: true         # trueä»£è¡¨æ— çŠ¶æ€(é»˜è®¤)ï¼Œfalseä»£è¡¨æœ‰çŠ¶æ€(äº‹åŠ¡)
```

**æ•ˆæœ**ï¼š
ä»£ç æŠ¥é”™ -> Spring æ‹¦æˆªå¼‚å¸¸ -> ç­‰ 1 ç§’ -> å†æ¬¡è°ƒç”¨ä½ çš„æ–¹æ³• -> è¿˜æŠ¥é”™ -> å†è¯• -> ... -> è¶…è¿‡ 3 æ¬¡ã€‚

### 2. é‡è¯•è€—å°½åçš„å¤„ç† (MessageRecoverer)

å½“é‡è¯• 3 æ¬¡è¿˜æ˜¯å¤±è´¥æ—¶ï¼ŒSpring é»˜è®¤ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘ auto æ¨¡å¼çš„ Nackï¼ŒMQ åˆä¼šé‡å‘... **è¿˜æ˜¯æ­»å¾ªç¯ï¼**
æ‰€ä»¥ï¼Œæˆ‘ä»¬å¿…é¡»å‘Šè¯‰ Springï¼šâ€œé‡è¯• 3 æ¬¡ä¸è¡Œå°±ç®—äº†ï¼Œåˆ«ç»™ MQ æŠ¥é”™äº†ï¼ŒæŒ‰æˆ‘çš„è§„çŸ©åŠã€‚â€

æˆ‘ä»¬éœ€è¦é…ç½® **MessageRecoverer** æ¥å£ã€‚å¸¸è§çš„å®ç°ç­–ç•¥æœ‰ï¼š

1. **RejectAndDontRequeueRecoverer (é»˜è®¤)**ï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯ï¼ˆwarn æ—¥å¿—ï¼‰ã€‚
2. **RepublishMessageRecoverer (å¼ºçƒˆæ¨è)**ï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯**è½¬å‘**åˆ°å¦ä¸€ä¸ªäº¤æ¢æœºï¼ˆä¸“é—¨å­˜é”™è¯¯æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼‰ï¼Œç­‰å¾…äººå·¥å¤„ç†ã€‚

### ä»£ç å®æˆ˜ï¼šé…ç½® RepublishMessageRecoverer

æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªä¸“é—¨çš„â€œé”™è¯¯äº¤æ¢æœºâ€å’Œâ€œé”™è¯¯é˜Ÿåˆ—â€ï¼Œç„¶åé…ç½®æ¢å¤ç­–ç•¥ã€‚

```java
@Configuration
public class ErrorMessageConfig {

    // 1. å£°æ˜é”™è¯¯äº¤æ¢æœº (Direct)
    @Bean
    public DirectExchange errorExchange() {
        return new DirectExchange("error.direct");
    }

    // 2. å£°æ˜é”™è¯¯é˜Ÿåˆ—
    @Bean
    public Queue errorQueue() {
        return new Queue("error.queue");
    }

    // 3. ç»‘å®š
    @Bean
    public Binding errorBinding(Queue errorQueue, DirectExchange errorExchange) {
        return BindingBuilder.bind(errorQueue).to(errorExchange).with("error");
    }

    // 4. é…ç½® MessageRecoverer (æ ¸å¿ƒ)
    @Bean
    public MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate) {
        // å½“é‡è¯•è€—å°½ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° error.direct äº¤æ¢æœºï¼Œè·¯ç”±é”®ä¸º error
        return new RepublishMessageRecoverer(rabbitTemplate, "error.direct", "error");
    }
}
```

**å®Œæ•´æµç¨‹æ€»ç»“**ï¼š
æ¶ˆè´¹è€…æŠ¥é”™ -> æœ¬åœ°é‡è¯• 3 æ¬¡ -> ä¾ç„¶å¤±è´¥ -> è§¦å‘ RepublishMessageRecoverer -> æ¶ˆæ¯è¢«å‘åˆ° error.queue -> æ¶ˆè´¹è€…å‘ MQ è¿”å› Ack (éª— MQ è¯´å¤„ç†å®Œäº†) -> è¿ç»´äººå‘˜æŸ¥çœ‹ error.queue å¤„ç†å¼‚å¸¸ã€‚

------



## 08. æ¶ˆè´¹è€…å¯é æ€§ - ä¸šåŠ¡å¹‚ç­‰æ€§ (Idempotency)

**åœºæ™¯**ï¼š
MQ ä¿è¯æ¶ˆæ¯**è‡³å°‘æŠ•é€’ä¸€æ¬¡**ï¼Œä½†ä¸èƒ½ä¿è¯**åªæŠ•é€’ä¸€æ¬¡**ã€‚
æ¯”å¦‚ï¼šæ¶ˆè´¹è€…æ‰£æ¬¾æˆåŠŸäº†ï¼Œæ­£è¦å‘ MQ è¿”å› Ack æ—¶ï¼Œç½‘ç»œæ–­äº†ã€‚MQ ä»¥ä¸ºä½ æ²¡å¤„ç†ï¼Œåˆå‘äº†ä¸€éã€‚
ç»“æœï¼š**ç”¨æˆ·è¢«æ‰£äº†ä¸¤æ¬¡é’±**ã€‚è¿™å°±æ˜¯éå¹‚ç­‰ã€‚

**ç›®æ ‡**ï¼šæ— è®ºåŒä¸€ä¸ªæ¶ˆæ¯è¢«å¤„ç†å¤šå°‘æ¬¡ï¼Œä¸šåŠ¡ç»“æœéƒ½åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚

> **éš¾ç‚¹ç†è§£ï¼šä¸ºä»€ä¹ˆ MQ åšä¸åˆ°â€œåªæŠ•é€’ä¸€æ¬¡â€ï¼Ÿ**  
> - MQ é¡¶å¤šèƒ½åšåˆ°â€œ**è‡³å°‘æŠ•é€’ä¸€æ¬¡**â€â€”â€”å› ä¸ºç½‘ç»œä¸ç¨³å®šæ—¶ï¼Œå®ƒå®å¯å¤šå‘ï¼Œä¹Ÿä¸èƒ½å†’ä¸¢æ¶ˆæ¯çš„é£é™©ã€‚  
> - æ‰€ä»¥â€œåªå¤„ç†ä¸€æ¬¡â€çš„è´£ä»»**è½åœ¨ä¸šåŠ¡è‡ªå·±èº«ä¸Š**ï¼šè¦ä¹ˆç”¨â€œå”¯ä¸€æ¶ˆæ¯ ID + å»é‡ï¼ˆRedis/DBï¼‰â€ï¼Œè¦ä¹ˆç”¨â€œæ›´æ–°è¯­å¥å¸¦çŠ¶æ€æ¡ä»¶ï¼ˆä¹è§‚é”ï¼‰â€ã€‚  
> - å®æˆ˜ä¸­ï¼Œä¸€èˆ¬æ˜¯ï¼š**é‡è¦çš„æ‰£æ¬¾/åº“å­˜ç±»æ“ä½œ + å¹‚ç­‰ç­–ç•¥**ï¼Œé…åˆå‰é¢çš„ Ack/Retry æ–¹æ¡ˆä¸€èµ·ç”¨ã€‚

### è§£å†³æ–¹æ¡ˆä¸€ï¼šå”¯ä¸€æ¶ˆæ¯ ID (UID) + æ•°æ®åº“å»é‡

**æ€è·¯**ï¼šç»™æ¯æ¡æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ IDï¼ˆæ¯”å¦‚è®¢å•å·ï¼‰ï¼Œæ¶ˆè´¹å‰å…ˆå»æŸ¥ä¸€ä¸‹è¿™ä¸ª ID æ˜¯ä¸æ˜¯å·²ç»å¤„ç†è¿‡äº†ã€‚

1. **ç”Ÿäº§è€…**ï¼šå‘é€æ¶ˆæ¯æ—¶å¸¦ä¸Š IDã€‚

   - CorrelationData æˆ–æ¶ˆæ¯ä½“å†…éƒ¨åŒ…å« orderIdã€‚

2. **æ¶ˆè´¹è€…**ï¼š

   - **æ–¹å¼ A (æ•°æ®åº“)**ï¼šè®¾è®¡ä¸€å¼  processed_messages è¡¨ï¼Œmessage_id ä¸ºä¸»é”®ã€‚

     ```sql
     INSERT INTO processed_messages (message_id) VALUES ('123')
     ```

     å¦‚æœæŠ¥é”™â€œä¸»é”®å†²çªâ€ï¼Œè¯´æ˜å¤„ç†è¿‡äº†ï¼Œç›´æ¥ Ackã€‚

   - **æ–¹å¼ B (Redis - æ¨è)**ï¼š

     ```java
     Boolean isNew = redisTemplate.opsForValue().setIfAbsent("mq:msg:123", "1", 1, TimeUnit.HOURS);
     if (!isNew) {
         // å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
         return;
     }
     // æ‰§è¡Œä¸šåŠ¡...
     ```

### è§£å†³æ–¹æ¡ˆäºŒï¼šä¸šåŠ¡çŠ¶æ€åˆ¤æ–­ (ä¹è§‚é”)

è¿™æ˜¯æ›´é«˜çº§ã€æ€§èƒ½æ›´å¥½çš„åšæ³•ï¼Œä¸éœ€è¦é¢å¤–çš„å»é‡è¡¨ã€‚

**æ€è·¯**ï¼šä¿®æ”¹ä¸šåŠ¡æ•°æ®æ—¶ï¼Œå¸¦ä¸ŠçŠ¶æ€æ¡ä»¶ã€‚

**åœºæ™¯**ï¼šæˆ‘ä»¬è¦æŠŠè®¢å•çŠ¶æ€ä»â€œæœªæ”¯ä»˜(1)â€æ”¹ä¸ºâ€œå·²æ”¯ä»˜(2)â€ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@RabbitListener(queues = "order.queue")
public void listenOrderMsg(String orderId) {
    
    // 1. ä¸è¦å…ˆæŸ¥å†æ”¹ (ä¸å®‰å…¨)
    // Order order = orderService.getById(orderId);
    // if (order.getStatus() == 2) return; ...
    
    // 2. æ¨èï¼šç›´æ¥åˆ©ç”¨ SQL çš„ CAS (Compare And Swap) æœºåˆ¶
    // SQL: UPDATE orders SET status = 2 WHERE id = 'order_123' AND status = 1;
    
    int rows = orderService.updateStatusToPaid(orderId);
    
    if (rows == 0) {
        System.out.println("è¯¥è®¢å•å·²ç»å¤„ç†è¿‡ï¼Œæˆ–è€…æ˜¯æ— æ•ˆè®¢å•");
    } else {
        System.out.println("è®¢å•å¤„ç†æˆåŠŸ");
    }
}
```

**è§£æ**ï¼š
ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼ŒçŠ¶æ€æ˜¯ 1ï¼Œæ›´æ–°æˆåŠŸï¼Œrows = 1ã€‚
ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆé‡å¤æ¶ˆè´¹ï¼‰ï¼ŒçŠ¶æ€å·²ç»æ˜¯ 2 äº†ï¼Œæ¡ä»¶ status = 1 ä¸æ»¡è¶³ï¼Œrows = 0ã€‚ä¸šåŠ¡æ•°æ®ä¸ä¼šè¢«ç ´åã€‚

------

**ç¬¬ä¸‰éƒ¨åˆ†æ€»ç»“**ï¼š

- **Ack æ¨¡å¼**ï¼šç”¨ autoï¼Œåˆ«ç”¨ noneã€‚
- **é‡è¯•æœºåˆ¶**ï¼šå¼€å¯ Spring Retry (æœ¬åœ°é‡è¯•) + é…ç½® RepublishMessageRecoverer (è½¬å‘å¼‚å¸¸æ¶ˆæ¯)ï¼Œæœç»æ­»å¾ªç¯ã€‚
- **å¹‚ç­‰æ€§**ï¼šä¸ºäº†å…œåº•ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„é‡å¤æ¶ˆè´¹ï¼Œå¿…é¡»ç”¨ Redis å”¯ä¸€ ID æˆ– æ•°æ®åº“ä¹è§‚é”ï¼ˆWHERE status = ...ï¼‰æ¥ä¿è¯å®‰å…¨ã€‚

**è‡³æ­¤ï¼ŒRabbitMQ å¯é æ€§çš„â€œä¸‰å¤§æŠ¤æ³•â€ï¼ˆç”Ÿäº§ã€MQã€æ¶ˆè´¹ï¼‰å…¨éƒ¨è®²å®Œã€‚**

## 09. å»¶è¿Ÿæ¶ˆæ¯ - ä»€ä¹ˆæ˜¯å»¶è¿Ÿæ¶ˆæ¯

**å®šä¹‰**ï¼š
ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œæ¶ˆè´¹è€…**ä¸æƒ³ç«‹åˆ»æ”¶åˆ°**ï¼Œè€Œæ˜¯æƒ³**ç­‰å¾…ç‰¹å®šæ—¶é—´**ï¼ˆä¾‹å¦‚ 5ç§’ã€30åˆ†é’Ÿã€24å°æ—¶ï¼‰ä¹‹åæ‰æ”¶åˆ°ã€‚

**ç»å…¸åœºæ™¯**ï¼š

1. **è¶…æ—¶è®¢å•**ï¼šç”¨æˆ·ä¸‹å•å 30 åˆ†é’Ÿæœªæ”¯ä»˜ï¼Œè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼Œå›æ»šåº“å­˜ã€‚
2. **é™æ—¶ä¼˜æƒ **ï¼šä¼˜æƒ åˆ¸å‘ç»™ç”¨æˆ· 24 å°æ—¶åè¿‡æœŸã€‚
3. **çŸ­ä¿¡é€šçŸ¥**ï¼šæ³¨å†Œå 3 å¤©ï¼Œå¦‚æœæ²¡æœ‰åç»­æ“ä½œï¼Œå‘é€ä¸€æ¡çŸ­ä¿¡æé†’ã€‚

RabbitMQ åŸç”Ÿå¹¶ä¸æ”¯æŒâ€œå»¶è¿Ÿæ¶ˆæ¯â€ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æŠ€å·§æ¥å®ç°ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

1. **æ­»ä¿¡äº¤æ¢æœº + TTL**ï¼ˆæ—©æœŸé€šç”¨æ–¹æ¡ˆï¼Œç¨éº»çƒ¦ï¼‰ã€‚
2. **å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶**ï¼ˆå®˜æ–¹æ’ä»¶ï¼Œæ¨èæ–¹æ¡ˆï¼Œç®€å•ï¼‰ã€‚

------

## 10. æ–¹æ¡ˆä¸€ï¼šæ­»ä¿¡äº¤æ¢æœº (DLX) + TTL

è¿™æ˜¯åœ¨ RabbitMQ æ²¡æœ‰æ’ä»¶ä¹‹å‰çš„ç»å…¸å®ç°æ–¹å¼ï¼Œé€šå¸¸è¢«ç§°ä¸ºâ€œ**æ›²çº¿æ•‘å›½**â€ã€‚

### 1. åŸç†å›¾è§£

åˆ©ç”¨ RabbitMQ çš„ä¸¤ä¸ªç‰¹æ€§é…åˆå®ç°ï¼š

1. **TTL (Time To Live)**ï¼šæ¶ˆæ¯æˆ–é˜Ÿåˆ—å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚å¦‚æœæ¶ˆæ¯è¶…æ—¶æœªè¢«æ¶ˆè´¹ï¼Œå°±ä¼šâ€œæ­»â€æ‰ã€‚
2. **DLX (Dead Letter Exchange)**ï¼šæ­»ä¿¡äº¤æ¢æœºã€‚å½“é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯â€œæ­»â€äº†ï¼ˆè¿‡æœŸäº†ï¼‰ï¼ŒRabbitMQ ä¼šè‡ªåŠ¨æŠŠè¿™æ¡æ¶ˆæ¯è½¬äº¤ç»™å¦ä¸€ä¸ªäº¤æ¢æœºï¼ˆå³ DLXï¼‰ã€‚

**æµç¨‹**ï¼š

1. åˆ›å»ºä¸€ä¸ª**æ²¡æœ‰æ¶ˆè´¹è€…**çš„é˜Ÿåˆ— queue.ttlï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 10ç§’ï¼‰ï¼Œå¹¶ç»‘å®šæ­»ä¿¡äº¤æ¢æœº exchange.dlxã€‚
2. æ¶ˆæ¯å‘ç»™ queue.ttlã€‚
3. æ¶ˆæ¯åœ¨é‡Œé¢èºº 10 ç§’ï¼Œæ²¡äººé¢†ï¼Œè¿‡æœŸæ­»äº¡ã€‚
4. RabbitMQ è‡ªåŠ¨æŠŠæ¶ˆæ¯æŠ•é€’ç»™ exchange.dlxã€‚
5. æˆ‘ä»¬çš„æ¶ˆè´¹è€…ç›‘å¬ queue.dlxï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰ï¼Œä»è€Œåœ¨ 10 ç§’åæ”¶åˆ°äº†æ¶ˆæ¯ã€‚

> **éš¾ç‚¹ç†è§£ï¼šTTL + DLX åƒæ˜¯â€œç»•ä¸€åœˆçš„é—¹é’Ÿâ€**  
> - TTL é˜Ÿåˆ—ç›¸å½“äºä¸€ä¸ªâ€œå€’è®¡æ—¶ä»“åº“â€ï¼Œæ¶ˆæ¯åœ¨é‡Œé¢â€œç¡è§‰â€ç­‰è¿‡æœŸã€‚  
> - è¿‡æœŸåå˜æˆâ€œæ­»ä¿¡â€ï¼Œè¢« DLX è½¬å‘åˆ°çœŸæ­£è¦æ¶ˆè´¹çš„é˜Ÿåˆ—ï¼Œç›¸å½“äº**é—¹é’Ÿå“äº†æ‰å«é†’æ¶ˆè´¹è€…**ã€‚  
> - ç¼ºç‚¹æ˜¯ï¼šä¸åŒå»¶è¿Ÿæ—¶é—´å¾€å¾€è¦å»ºä¸åŒé˜Ÿåˆ—ï¼ˆ5 åˆ†é’Ÿã€30 åˆ†é’Ÿå„ä¸€æ¡çº¿ï¼‰ï¼Œ**é˜Ÿåˆ—ä¼šçˆ†ç‚¸å¼å¢å¤š**ã€‚

### 2. ä»£ç å®ç° (Spring Boot)

æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªäº¤æ¢æœºã€ä¸¤ä¸ªé˜Ÿåˆ—ã€ä¸¤ä¸ªç»‘å®šã€‚

```java
@Configuration
public class TtlDlxConfig {

    // ================== 1. æ­»ä¿¡éƒ¨åˆ† (æœ€ç»ˆæ¶ˆè´¹çš„åœ°æ–¹) ==================
    
    // 1.1 å£°æ˜æ­»ä¿¡äº¤æ¢æœº (æ™®é€šäº¤æ¢æœº)
    @Bean
    public DirectExchange dlxExchange() {
        return new DirectExchange("dlx.direct");
    }

    // 1.2 å£°æ˜æ­»ä¿¡é˜Ÿåˆ— (æ¶ˆè´¹è€…ç›‘å¬è¿™ä¸ª)
    @Bean
    public Queue dlxQueue() {
        return new Queue("dlx.queue");
    }

    // 1.3 ç»‘å®š
    @Bean
    public Binding dlxBinding() {
        return BindingBuilder.bind(dlxQueue()).to(dlxExchange()).with("dlx");
    }

    // ================== 2. TTL éƒ¨åˆ† (æš‚å­˜æ¶ˆæ¯çš„åœ°æ–¹) ==================

    // 2.1 å£°æ˜ TTL äº¤æ¢æœº
    @Bean
    public DirectExchange ttlExchange() {
        return new DirectExchange("ttl.direct");
    }

    // 2.2 å£°æ˜ TTL é˜Ÿåˆ— (é‡ç‚¹ä¸­çš„é‡ç‚¹ï¼)
    @Bean
    public Queue ttlQueue() {
        return QueueBuilder.durable("ttl.queue")
                .ttl(10000) // è®¾ç½®é˜Ÿåˆ—æ¶ˆæ¯è¿‡æœŸæ—¶é—´ä¸º 10ç§’ (æ‰€æœ‰æ¶ˆæ¯ç»Ÿä¸€)
                .deadLetterExchange("dlx.direct") // ç»‘å®šæ­»ä¿¡äº¤æ¢æœº
                .deadLetterRoutingKey("dlx")      // æ­»ä¿¡æŠ•é€’çš„ RoutingKey
                .build();
    }

    // 2.3 ç»‘å®š
    @Bean
    public Binding ttlBinding() {
        return BindingBuilder.bind(ttlQueue()).to(ttlExchange()).with("ttl");
    }
}
```

**ç¼ºç‚¹**ï¼š
å¦‚æœæˆ‘ä»¬è¦å®ç° 5åˆ†é’Ÿã€10åˆ†é’Ÿã€30åˆ†é’Ÿå¤šç§å»¶è¿Ÿï¼Œå°±å¾—åˆ›å»ºå¾ˆå¤šä¸ª TTL é˜Ÿåˆ—ï¼Œéå¸¸éº»çƒ¦ã€‚

------

## 11. æ–¹æ¡ˆäºŒï¼šå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶ (Delayed Message Plugin)

è¿™æ˜¯ç›®å‰æœ€æ¨èçš„æ–¹æ¡ˆã€‚RabbitMQ å®˜æ–¹æ¨å‡ºäº†ä¸€ä¸ªæ’ä»¶ rabbitmq_delayed_message_exchangeã€‚

### 1. åŸç†

å®‰è£…æ’ä»¶åï¼ŒRabbitMQ ä¼šå¤šå‡ºä¸€ç§äº¤æ¢æœºç±»å‹ï¼šx-delayed-messageã€‚
è¿™ç§äº¤æ¢æœºæ˜¯ä¸ªâ€œæš‚å­˜åŒºâ€ã€‚æ¶ˆæ¯å‘ç»™å®ƒåï¼Œå®ƒ**ä¸ä¼šç«‹å³è·¯ç”±**åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯æŠŠæ¶ˆæ¯å­˜åœ¨å†…éƒ¨çš„æ•°æ®åº“é‡Œã€‚ç­‰æ—¶é—´åˆ°äº†ï¼Œå®ƒå†æŠŠæ¶ˆæ¯æŠ•é€’ç»™é˜Ÿåˆ—ã€‚

> **éš¾ç‚¹ç†è§£ï¼šå’Œ TTL + DLX æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ**  
> - TTL + DLXï¼šæ¶ˆæ¯æŒ‰â€œä¸åŒå»¶è¿Ÿæ—¶é—´â€åˆ†æ•£åœ¨ä¸åŒ TTL é˜Ÿåˆ—é‡Œï¼Œé˜Ÿåˆ—å¤šã€é…ç½®é‡ã€‚  
> - Delayed Pluginï¼š**åªæœ‰ä¸€ä¸ªå»¶è¿Ÿäº¤æ¢æœº**ï¼Œæ¯æ¡æ¶ˆæ¯è‡ªå·±å¸¦â€œå»¶è¿Ÿå¤šä¹…â€çš„å‚æ•°ï¼Œæ›´çµæ´»ã€‚  
> - æ‰€ä»¥å®æˆ˜é‡Œï¼Œä¸€èˆ¬ä¼˜å…ˆé€‰æ’ä»¶æ–¹æ¡ˆï¼›TTL + DLX æ›´åƒæ˜¯â€œæ²¡æœ‰æ’ä»¶æ—¶çš„å…¼å®¹æ–¹æ¡ˆâ€ã€‚

### 2. ä»£ç å®ç° (Spring Boot)

å‰æï¼šç¡®ä¿ä½ çš„ RabbitMQ æœåŠ¡ç«¯å·²ç»å®‰è£…å¹¶å¯ç”¨äº†è¯¥æ’ä»¶ã€‚

#### 2.1 å£°æ˜å»¶è¿Ÿäº¤æ¢æœº

è¿™é‡Œä¸èƒ½ç”¨æ ‡å‡†çš„ DirectExchangeï¼Œå¾—ç”¨ CustomExchangeï¼ˆè‡ªå®šä¹‰äº¤æ¢æœºï¼‰ã€‚

```java
@Configuration
public class DelayPluginConfig {

    @Bean
    public CustomExchange delayExchange() {
        Map<String, Object> args = new HashMap<>();
        // å…³é”®å‚æ•°ï¼šå‘Šè¯‰æ’ä»¶ï¼Œå»¶è¿Ÿç»“æŸåï¼ŒæŒ‰ direct æ–¹å¼è·¯ç”±
        args.put("x-delayed-type", "direct");
        
        // å‚æ•°ï¼šname, type, durable, autoDelete, arguments
        return new CustomExchange("plugin.delay.exchange", "x-delayed-message", true, false, args);
    }

    @Bean
    public Queue delayQueue() {
        return new Queue("plugin.delay.queue");
    }

    @Bean
    public Binding delayBinding() {
        return BindingBuilder.bind(delayQueue()).to(delayExchange()).with("delay.key").noargs();
    }
}
```

#### 2.2 åŸºäºæ³¨è§£çš„å£°æ˜ (æ›´ç®€å•)

å¦‚æœä½ å–œæ¬¢ç”¨æ³¨è§£ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```java
@RabbitListener(bindings = @QueueBinding(
        value = @Queue(name = "plugin.delay.queue"),
        exchange = @Exchange(
                name = "plugin.delay.exchange", 
                delayed = "true" // å¼€å¯å»¶è¿Ÿå±æ€§ (Spring AMQP æ”¯æŒ)
        ),
        key = "delay.key"
))
public void listenDelayedMessage(String msg) {
    System.out.println("æ”¶åˆ°å»¶è¿Ÿæ¶ˆæ¯: " + msg);
}
```

------



## 12. ç»¼åˆæ¡ˆä¾‹ï¼šå–æ¶ˆè¶…æ—¶è®¢å•

ç»“åˆæˆ‘ä»¬å­¦è¿‡çš„æ‰€æœ‰çŸ¥è¯†ï¼Œå®ç°ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚

**ä¸šåŠ¡éœ€æ±‚**ï¼šç”¨æˆ·ä¸‹å•ï¼Œ30åˆ†é’Ÿæœªæ”¯ä»˜ï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ã€‚

### 1. æ ¸å¿ƒæ€è·¯

1. **ä¸‹å•æ—¶**ï¼šä¿å­˜è®¢å•åˆ°æ•°æ®åº“ï¼ˆçŠ¶æ€ï¼šæœªæ”¯ä»˜ï¼‰ï¼ŒåŒæ—¶å‘ MQ å‘é€ä¸€æ¡â€œæ£€æŸ¥è®¢å•â€çš„å»¶è¿Ÿæ¶ˆæ¯ï¼ˆå»¶è¿Ÿ30åˆ†é’Ÿï¼‰ï¼Œæ¶ˆæ¯å†…å®¹æ˜¯ orderIdã€‚
2. **30åˆ†é’Ÿå**ï¼šMQ å°†æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚
3. **æ¶ˆè´¹æ—¶**ï¼š
   - æ‹¿ç€ orderId å»æ•°æ®åº“æŸ¥è®¢å•ã€‚
   - åˆ¤æ–­çŠ¶æ€ï¼š
     - å¦‚æœæ˜¯ **â€œå·²æ”¯ä»˜â€**ï¼šè¯´æ˜ç”¨æˆ·æŒ‰æ—¶ä»˜é’±äº†ï¼Œå¿½ç•¥è¯¥æ¶ˆæ¯ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚
     - å¦‚æœæ˜¯ **â€œæœªæ”¯ä»˜â€**ï¼šè¯´æ˜ç”¨æˆ·è¶…æ—¶äº†ï¼Œæ‰§è¡Œå–æ¶ˆè®¢å•é€»è¾‘ï¼ˆæ”¹çŠ¶æ€ä¸ºå·²å–æ¶ˆã€æ¢å¤åº“å­˜ï¼‰ã€‚

### 2. å‘é€å»¶è¿Ÿæ£€æµ‹æ¶ˆæ¯ (Producer)

æˆ‘ä»¬éœ€è¦åˆ©ç”¨ Header ä¸­çš„ x-delay å±æ€§æ¥è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼ˆå•ä½æ¯«ç§’ï¼‰ã€‚

```java
@Autowired
private RabbitTemplate rabbitTemplate;

public void createOrder(Order order) {
    // 1. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
    orderRepository.save(order);
    
    // 2. å‘é€å»¶è¿Ÿæ¶ˆæ¯
    String exchange = "plugin.delay.exchange";
    String routingKey = "delay.key";
    
    // è¿™é‡Œçš„ correlationData æ˜¯ä¸ºäº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶(é«˜çº§ç¯‡å‰é¢è®²çš„)
    CorrelationData correlationData = new CorrelationData(order.getId());
    
    rabbitTemplate.convertAndSend(exchange, routingKey, order.getId(), message -> {
        // è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼š30åˆ†é’Ÿ = 1800000 æ¯«ç§’
        // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œè®¾ä¸º 10ç§’ (10000)
        message.getMessageProperties().setDelay(10000); 
        return message;
    }, correlationData);
    
    System.out.println("è®¢å•åˆ›å»ºæˆåŠŸï¼Œå·²å‘é€å»¶è¿Ÿæ£€æŸ¥æ¶ˆæ¯ï¼Œè®¢å•å·ï¼š" + order.getId());
}
```

### 3. ç›‘å¬å¹¶å¤„ç† (Consumer)

è¿™é‡Œå¿…é¡»æ³¨æ„**å¹‚ç­‰æ€§**ï¼è™½ç„¶æˆ‘ä»¬æ˜¯å»¶è¿Ÿæ£€æµ‹ï¼Œä½†åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¯èƒ½ç”¨æˆ·åˆšå¥½åœ¨ç¬¬ 29åˆ†59ç§’ æ”¯ä»˜äº†ï¼Œè€Œæˆ‘ä»¬çš„æ£€æŸ¥æ¶ˆæ¯åœ¨ç¬¬ 30åˆ†00ç§’ åˆ°äº†ã€‚

```java
@Component
public class OrderDelayConsumer {

    @Autowired
    private OrderService orderService;

    @RabbitListener(queues = "plugin.delay.queue")
    public void checkOrderStatus(String orderId) {
        // 1. æŸ¥è¯¢æ•°æ®åº“æœ€æ–°çŠ¶æ€
        Order order = orderService.getById(orderId);
        
        // 2. åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        if (order == null) {
            System.out.println("è®¢å•ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«ç‰©ç†åˆ é™¤");
            return;
        }

        // 3. æ ¸å¿ƒåˆ¤æ–­ (å¹‚ç­‰æ€§ + ä¸šåŠ¡é€»è¾‘)
        if (order.getStatus() == 2) {
            // çŠ¶æ€ 2 ä»£è¡¨å·²æ”¯ä»˜
            System.out.println("è®¢å•å·²æ”¯ä»˜ï¼Œæ— éœ€å–æ¶ˆã€‚è®¢å•å·ï¼š" + orderId);
        } else if (order.getStatus() == 1) {
            // çŠ¶æ€ 1 ä»£è¡¨æœªæ”¯ä»˜ -> æ‰§è¡Œå–æ¶ˆ
            System.out.println("è®¢å•è¶…æ—¶æœªæ”¯ä»˜ï¼Œæ‰§è¡Œå–æ¶ˆé€»è¾‘... è®¢å•å·ï¼š" + orderId);
            
            // åŠ¡å¿…ä½¿ç”¨ä¹è§‚é”æˆ–äº‹åŠ¡æ›´æ–°ï¼Œé˜²æ­¢å¹¶å‘
            // update orders set status = 3 where id = ? and status = 1
            orderService.cancelOrder(orderId);
            
            // å¯é€‰ï¼šæ¢å¤åº“å­˜
            // inventoryService.resumeStock(order.getProductId());
        } else {
            System.out.println("è®¢å•çŠ¶æ€å¼‚å¸¸æˆ–å·²æ‰‹åŠ¨å–æ¶ˆ");
        }
    }
}
```

------



# æ€»ç»“ï¼šé«˜çº§ç¯‡å¤ä¹ æ¸…å•

åˆ°è¿™é‡Œï¼ŒRabbitMQ é«˜çº§ç¯‡çš„å†…å®¹å°±å…¨éƒ¨ç»“æŸäº†ã€‚æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ•´ä¸ªçŸ¥è¯†ä½“ç³»ï¼š

1. **æ¶ˆæ¯ç”±äºç½‘ç»œæ²¡å‘å‡ºå»ï¼Ÿ** -> **ç”Ÿäº§è€…é‡è¿**ã€‚
2. **æ¶ˆæ¯å‘å‡ºå»ä¸çŸ¥é“åˆ°æ²¡åˆ°ï¼Ÿ** -> **Publisher Confirm/Return**ã€‚
3. **MQ æŒ‚äº†æ¶ˆæ¯ä¼šä¸¢å—ï¼Ÿ** -> **æŒä¹…åŒ–** (Exchange, Queue, Message)ã€‚
4. **æ¶ˆæ¯ç§¯å‹å¤ªå¤šå†…å­˜çˆ†äº†ï¼Ÿ** -> **Lazy Queue**ã€‚
5. **æ¶ˆè´¹è€…å¤„ç†æŠ¥é”™ä¼šæ­»å¾ªç¯å—ï¼Ÿ** -> **Auto Ack + Spring Retry + å¼‚å¸¸è½¬å‘ (Republish)**ã€‚
6. **é‡å¤æ¶ˆè´¹æ‰£äº†ä¸¤æ¬¡é’±ï¼Ÿ** -> **å¹‚ç­‰æ€§** (Redis ID / æ•°æ®åº“ä¹è§‚é”)ã€‚
7. **æ€ä¹ˆåšè¶…æ—¶å–æ¶ˆè®¢å•ï¼Ÿ** -> **å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶** (x-delay header)ã€‚
